= 管理者の仕事

本章はLinuxでシステムの管理を行なう場合に使われるコマンドについて焦点を当てます。ユーザの作成や削除、ユーザパスワードの設定、グループを作成してユーザを割り当てたりグループ設定の変更やグループの削除について理解を深めましょう。


## グループとユーザ

Linuxを利用するにはユーザアカウントが必要です。任意のユーザでログインすると、Linuxを利用することができます。これはログインしたユーザがLinuxというシステムの利用権限を持っているためです。グループを使えば複数のユーザを束ねることができます。

グループとユーザを適切に設定することで、ファイルやディレクトリ、任意のプログラムやシェルスクリプトなどを必要なユーザにのみ参照・編集する権限や実行する権限を与えることができます。

グループとユーザを作成・変更・削除するコマンドは管理コマンドなので、管理者であるrootユーザで実行する必要があります。以降の章でも、多くのシステム管理用のコマンドを実行する際はrootユーザで実行してください。間違えて一般ユーザで実行しようとしても何も起こらないか、エラーが表示されて正常に処理を行なえません。

本教科書の実行例で冒頭が$になっているものはユーザ権限でも実行可能ですが、#になっているコマンドはroot権限で実行する必要があります。学校などの環境によってはrootユーザを使えない場合も多々ありますのでご了承ください。rootユーザになるコマンドについては、この章で後述します。

### ユーザ

メモリやファイルなどのさまざまな資源を利用するためにユーザという最小単位で権限を定義できます。
インストール時から用意されているユーザに加え、システム管理者が必要に応じてユーザを定義できます。
ユーザの定義は/etc/passwdファイルに記述します。
Linuxでは/etc/passwdファイルをエディタで直接編集する代わりに、useraddコマンドで新しいユーザを追加し、usermodコマンドでユーザの定義を変更し、userdelコマンドでユーザを削除することが推奨されています。

### ユーザの作成

新しくユーザを作成するにはuseraddコマンドを使います。
ユーザには数字であるユーザIDを割り振ります。
ユーザは必ずグループに所属します。
作成したユーザをログインユーザとして使用する場合は、後述するpasswdコマンドにてパスワードを登録する必要があります。

書式
useradd ユーザ名


オプション
-c コメント
コメント(文字列)を指定します。

-g グループ名
プライマリグループ名を指定します。グループ名は/etc/groupファイルで定義したグループ名です。

-G グループ名
補助グループを指定します。

-d
ホームディレクトリを指定します。

-s
シェルを指定します。デフォルトで/bin/bashが指定されているディストリビューションが多く、ログインしないユーザはnologinを指定するなどします。

-u ユーザID番号
ユーザID番号を指定します。



○実習: ユーザの作成


ユーザを作成したあと、ユーザが作成できたかhomeディレクトリを確認します。

# useradd owl}
（ユーザを作成）
# ls /home/}
owl
（homeディレクトリを確認）     


ユーザowlを作成できました。


○実習: ユーザIDを指定したユーザの作成


次にユーザIDを指定してユーザを作成してみましょう。

まずはユーザID番号が1001のユーザが/etc/passwdファイルに登録されているか調べます。
usersグループに所属するユーザIDが1001のpenguinユーザを作ります。
/etc/passwdファイルにpenguinユーザが作成されたかgrepコマンドで調べてください。

# grep 1001 /etc/passwd}
（当てはまる行がなければユーザIDは未登録）
# useradd -g users -u 1001 penguin}
（ユーザを作成）
# grep penguin /etc/passwd}
penguin:x:1001:100::/home/penguin:/bin/bash
（作成されたユーザを表示）


### ユーザアカウントの変更

ユーザのアカウントを変更するにはusermodコマンドを使います。

書式
usermod  ユーザ名


オプション
-c コメント
コメント(文字列)を変更します。

-g グループ名
プライマリグループ名を変更します。グループ名は/etc/groupファイルで定義したグループ名です。

-G グループ名
補助グループを変更します。

-l ユーザ名
既存のユーザ名を変更します。

-u ユーザID番号
ユーザID番号を変更します。



○実習: ユーザアカウントのコメントの変更


penguinユーザのコメントを調べてから、コメントを指定します。
penguinユーザのコメントが追加されているかを確認してください。

# grep penguin /etc/passwd}
penguin:x:1001:100::/home/penguin:/bin/bash
（ユーザアカウントを表示）
# usermod -c "LPI-Japan Certification" penguin}
（コメントを追加）
# grep penguin /etc/passwd}
penguin:x:1001:100:LPI-Japan Certification}:/home/penguin:/bin/bash
（ユーザアカウントを表示して変更内容を確認）



### ユーザの削除

ユーザを削除するにはuserdelコマンドを使います。

書式
userdel ユーザ名


オプション
-r
ホームディレクトリを削除します。



○実習: ユーザアカウントの削除


penguin ユーザの情報を表示してから、penguin ユーザを削除します。
penguinユーザが登録されていないことを確認してください。

# grep penguin /etc/passwd}
penguin:x:1001:100:LPI-Japan Certification:/home/penguin:/bin/bash
（登録されているpenguinユーザの情報を確認）
# userdel penguin}
（penguinユーザを削除）
# grep penguin /etc/passwd}
（penguinユーザの情報を確認）
#
（ユーザが削除されたので表示されません）


### グループ

複数のユーザの権限をまとめて扱うためにグループを使います。ユーザは必ず1つ以上のグループに所属していて、主に所属するグループをプライマリグループと呼びます。
最初から用意されているグループに加え、システム管理者が必要に応じてグループを定義できます。
グループの定義は/etc/groupファイルに記述します。
Linuxでは/etc/groupファイルをエディタで直接編集する代わりに、groupaddコマンドで新しいグループを追加し、groupmod コマンドでグループの定義を変更し、groupdel コマンドでグループを削除することが推奨されています。

### グループの作成

新しくグループを作成するにはgroupaddコマンドを使います。
グループには数字のグループIDを割り振ります。

書式
groupadd  グループ名


オプション
-g グループID番号
グループID番号を指定します。



○実習: 新しく自分が使うグループの作成


グループID1001が/etc/groupファイルに登録されているか調べます。
グループID1001のlinucグループを追加します。
/etc/groupファイルにlinucグループが作成されたかgrepコマンドで調べてください。

# grep 1001 /etc/group}
（グループIDがすでに利用されていないことを確認）
# groupadd -g 1001 linuc}
（新しいlinucグループを作成）
# grep linuc /etc/group}
linuc:x:1001:
（作成したグループを表示）


### グループの登録情報の変更

グループの定義を変更するにはgroupmodコマンドを使います。

書式
groupmod [-g gid] [-n new-group-name] 変更対象のグループ


オプション
-n
既存のグループ名を変更する場合に指定します。

-g
既存のグループIDを変更します。100未満のグループIDはシステムで使われているため、指定できません。



$ groupmod -n penguin dolphin
（dolphinグループをpenguinグループに名前変更） 
$ groupmod -g 777 penguin
（penguinグループIDを777に変更）



○実習: 登録したグループ名の変更


linucグループの情報を表示します。
linucグループの名前をlinuxに変更したあと、linuxグループの情報を確認してください。

# grep linuc /etc/group}
linuc:x:1001:
（登録されているグループの表示）
# groupmod -n linux linuc}
（グループ名の変更）
# grep linux /etc/group}
linux:x:1001:
（変更されたグループの表示）


### グループを削除

グループを削除するにはgroupdelコマンドを使います。
groupdelコマンドでは登録されているグループの情報を削除します。
ユーザが所属していないグループのみ削除できます。

書式
groupdel グループ名



○実習: 登録したユーザの削除


linuxグループを作成してから、linuxグループを削除します。
linuxグループが削除されていることを確認してください。

# grep 1001 /etc/group}
（"1001"を鍵として/etc/group内を検索※）
# groupadd -g 1001 linux}
（グループID1001のグループlinuxを作成）
# grep linux /etc/group}
linux:x:1001:
（作成したグループを確認）
# groupdel linux}
（グループlinuxを削除）
# grep 1001 /etc/group}
（削除されたグループを確認）
#
（グループが削除されたので1行も表示されません）

※グループID 1001のグループを作成するため

## パスワードとパスワードファイル

グループの定義は/etc/groupファイル(グループファイル)に、ユーザの定義は/etc/passwdファイル(パスワードファイル)に記述されています。
ユーザを利用するにはパスワードが必要で、パスワードは/etc/shadowファイル(シャドウファイル)に暗号化されて記録されます。
パスワードの変更はpasswdコマンドを使っておこないます。

### パスワードファイル(/etc/passwd)

ユーザの情報は/etc/passwdファイル(パスワードファイル)に保存され、1行に1ユーザの情報を:で区切って記述します。
パスワードファイルに登録された1ユーザの内容(1行)は次の様になります。

account:password:UID:GID:GECOS:directory:shell


//tsize[60,70]
//table[tbl9][パスワードファイルの内容]{
項目	内容	
---------------------------------------------------------------------------
account	そのシステムでのユーザ名。大文字を含まないようにする
password	以前はユーザの暗号化されたパスワード、現在は 'x' です
UID	ユーザ ID 番号
GID	ユーザが属するプライマリグループ ID 番号
GECOS	ユーザの名前またはコメントのフィールド
directory	ユーザのホームディレクトリ
shell	ログイン時に起動されるユーザのコマンドインタプリタ


※GECOS = General Electric Comprehensive Operating System

従来はパスワードファイルに暗号化されたパスワードを記述していましたが、多くのディストリビューションはセキュリティを考慮してシャドウファイルにパスワードを記述しています。パスワードファイルはエディタで直接編集するべきではありません。useraddコマンドなどのコマンドを使って操作することが推奨されます。

### グループファイル(/etc/group)

グループの情報は/etc/groupファイル(グループファイル)に保存され、1行に1グループの情報を:で区切って記述します。
グループファイルに登録された1つのグループの内容(1行)は次の様になります。

group_name:password:GID:user_list


グループファイルの内容
項目	内容	
---------------------------------------------------------------------------
group_name	グループの名前。
password	以前は暗号化されたグループのパスワード、またはパスワードが不要なら空欄
GID	グループID番号
user_list	グループに所属するユーザ名のリスト。それぞれのユーザ名はコンマで区切られる。


グループファイルはエディタで直接編集するべきではありません。groupaddコマンドなどのコマンドを使って操作することが推奨されます。

### パスワード

ユーザの権限を使うにはユーザ名とパスワードを使って認証します。
作成したユーザはパスワードを登録するとログインできるようになります。
ユーザのパスワードを登録・変更するにはpasswdコマンドがあります。
パスワードの登録にはパスワードが必要なので、初めてパスワードを変換するのはシステム管理のためのrootユーザ(スーバーユーザ)である必要があります。

書式
passwd [ユーザ名]


ユーザのパスワード登録と変更
ユーザのパスワードを登録したり、変更します。


○実習: パスワードの設定


rootユーザで、penguinユーザのパスワードを変更します。
パスワードが変更できたら、コンソールから一回ログアウトし、再びログインをしてください。

# passwd penguin}
ユーザ penguin のパスワードを変更。
新しいパスワード: xxxxxxxx
新しいパスワードを再入力してください: xxxxxxxx
passwd: 全ての認証トークンが正しく更新できました。
# exit}
（rootユーザをログアウト）

CentOS release 6.3 (Final)
Kernel 2.6.32-279.1.1.el6 on an i686
localhost login: penguin}
（ユーザ名を入力）
Password: xxxxxxxx}
（パスワードを入力）
Last login: Wed Jul 18 10:10:10 from 192.168.1.100
$
（ユーザログインに成功するとプロンプトが表示される）


パスワードは複雑なものを設定するように心がけてください。英数文字だけでなく小文字と大文字を混ぜたり記号をいれるなど、他人から推測されにくい、適切なパスワードを設定してください。

### シャドウファイル(/etc/shadow)

ユーザのパスワードはパスワードファイルではなく、シャドウファイル(/etc/shadow)に保存されます。
シャドウファイルに登録された1つのユーザ(1行)の内容は次の様になります。

account:password:last_changed:may_be_changed:must_be_changed:warned:expires:dis
abled:reserved


シャドウファイルの内容
項目	内容	
---------------------------------------------------------------------------
account	ユーザ名
password	暗号化されたパスワード
last_changed	1970 年 1 月 1 日から、最後にパスワードが変更された日までの日数
may_be_changed	パスワードが変更可能となるまでの日数
must_be_changed	パスワードを変更しなくてはならなくなる日までの日数
warned	パスワード有効期限が来る前に、ユーザが警告を受ける日数
expires	パスワード有効期限が過ぎ、アカウントが使用不能になるまでの日数
disabled	1970 年 1 月 1 日からアカウントが使用不能になる日までの日数
reserved	予約フィールド


シャドウファイルはエディタで直接編集するべきではありません。日付に使われている基準の1970年1月1日はLinuxシステムが基準としている時間です。

## 用意されているユーザとグループ

Linuxはインストールしてすぐにそのシステムを利用できるように、ユーザとそのユーザが所属するグループが用意されています。ユーザやグループは必要に応じて複数追加できます。

### 一般のユーザとグループ

Linuxにログインするにはアカウントが必要です。アカウントを作成するとユーザ名と同様の名前のグループが作られ、ユーザはそのユーザグループに所属しているとシステムに登録されます。

グループは複数のユーザをまとめるためにあります。個別のユーザを所属部署などの単位でグループ化することができます。グループを使うことでシステム上にあるディレクトリのアクセス権を設定して、特定のグループに属したユーザのみアクセスできるディレクトリを作成するといった使い方や、特定グループに属しているユーザのみ後述のrootユーザになることができるような運用が可能になります。

### rootユーザ

rootユーザはシステム設定の変更や、プログラムのインストールや削除、ユーザを作成・削除する事ができる、利用に制限がない特別なユーザです。rootユーザはアクセス権に関係なくすべてのユーザのディレクトリへのアクセス、コンテンツの読み書きが行なえるなどの点で一般ユーザとは異なります。

このようにrootユーザでログインできれば全ての操作を行なうことができてしまうため、rootユーザのアカウントは厳格に管理する必要があります。


### suコマンド

suコマンドはすでに別のユーザでログインしているユーザが、一時的に他のユーザになるためのコマンドです。suコマンドを実行する際、オプションとしてユーザを指定しない場合はrootユーザでシェルを起動します。

オプションを付けずにsuコマンドを実行した場合はカレントディレクトリを変更せずにrootユーザでログインします。カレントディレクトリをrootのホームディレクトリに変更してログインするには「su -」、もしくは「su - root」と実行することでカレントディレクトリを変更した上でrootユーザでログインできます。

rootユーザでログインすると、システム管理用のコマンドを実行することができます。
複数人でLinuxシステムを管理している場合は、rootユーザで直接ログインして作業をすると、rootユーザとしての履歴だけが残り、誰がどんな作業をしたのかの履歴が残りません。
一般ユーザからrootユーザへ切り替えると、rootユーザで作業を開始した時間などは直ぐにわかります。安全や管理を考えると、一般のユーザでログインしてからrootユーザの権限を取得し、システム作業することが望ましいでしょう。


書式
su
su - [ユーザ]


オプション
su -（もしくはsu - root）
rootユーザになることができます。

su - user
指定したユーザになることができます。



○実習: rootユーザになるsuコマンドの実行


それではユーザからrootユーザになってみましょう。ユーザ権限では見られないログファイルをroot権限になると閲覧できるのを確認してみましょう。

$ cat /var/log/messages}
cat: /var/log/messages: 許可がありません

$ su -}
（rootユーザへ移行）
パスワード： xxxxxx}
# cat /var/log/messages} 
Mar 20 08:51:46 localhost syslogd 1.4.1: restart.
Mar 20 08:51:46 localhost kernel: klogd 1.4.1, log source = /proc/kmsg started.
（略）


### rootユーザでコマンドを実行するsudoコマンド

sudoコマンドを使えば、スーパーユーザ（root）権限でコマンドを実行できます。
普段作業するときはユーザ権限で行ない、必要に応じてsudoを使いコマンドを実行することで、suコマンドでユーザをrootに切り替えることなく、root権限が必要な設定やプログラムを実行することができます。

-uオプションを付けてsudoコマンドを実行すると、任意のユーザでコマンドを実行できます。オプションを付けないでsudoコマンドを実行した場合はroot権限でコマンドを実行します。

CentOSでは初期設定のままではsudoコマンドは利用できません。sudoコマンドを使うにはユーザをwheelグループというスーパーユーザ（root）特権を持つグループに登録する必要があります。

sudoの設定は/etc/sudoersファイルを編集することでユーザがsudoコマンドを利用できるようになります。
/etc/sudoersファイルはvisudoコマンドを実行すると編集できます。

書式
sudo コマンド
スーパーユーザ（root）権限でコマンドを実行

例1:
sudo cat /var/log/message


オプション
-u ユーザ
指定したユーザでコマンドを実行します。



○実習: 一般ユーザから管理コマンドの実行


sudoを使いたいpenguinユーザをwheelグループの所属にします。
visudoコマンドで/etc/sudoersファイルを編集してwheelグループの定義を有効にします。suコマンドでpenguinユーザに移行してからsudoコマンドを試してください。

$ visudo}
（ユーザpenguinでvisudoを実行）
visudo: /etc/sudoers: Permission denied
visudo: /etc/sudoers: Permission denied
（管理権限を持たないユーザではvisudoを実行できない）
# su -}
パスワード: xxxxxx
# usermod -G wheel penguin}
（wheelグループにユーザpenguinを追加）
# vigr}
（wheelグループにユーザ追加されたか確認）
wheel:x:10:root
↓
wheel:x:10:root,penguin

# visudo}
（wheelグループを有効に設定）
# %wheel        ALL=(ALL)       ALL
↓
  %wheel        ALL=(ALL)       ALL
# su - penguin}
（rootユーザがsuするときは、パスワード入力不要）
$ sudo visudo}
（ユーザpenguinは管理グループに所属するユーザなのでvisudoを実行可能）
[sudo] password for penguin:xxxxxx}
（コマンドを実行するユーザのパスワードを入力する）


/etc/sudoersファイルにある以下のオプションを有効にすると、wheelグループに所属するユーザがsudoコマンドを実行した場合、パスワードを聞かれることなくコマンドを実行できるようになります。
この設定はデフォルトでは無効化されています。

# %wheel        ALL=(ALL)       NOPASSWD: ALL

