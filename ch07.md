# ユーザ権限とアクセス権

ディレクトリとファイルの所有者と所有権について理解します。ファイル所有者と所有権を設定・変更するコマンドとしてchownコマンド、chmodコマンド、chgrpコマンドを説明します。

###[column] この章の内容

8.1 ファイルの所有者と所有グループ

8.1.1 所有者の変更

8.1.2 所有グループの変更

8.2 ファイルとアクセス権

8.2.1 ファイルに設定できるアクセス権

8.2.2 ファイルのモード変更

8.2.3 ファイル作成のモード

8.3 章末テスト

###[/column]



## ファイルの所有者と所有グループ

ファイル作成者のユーザIDとグループIDがファイルの所有者と所有グループとなります。
所有者と所有グループはファイルの情報として重要な属性です。
所有者はchownコマンドで変更でき、所有グループはchgrpコマンドで変更できます。

### 所有者の変更

ファイルの所有者を変更するにはchownコマンドを使います。

書式
chown ユーザ[.グループ] ディレクトリ
chown ユーザ[.グループ] ファイル


ユーザとグループを変更するには、rootユーザである必要があります。
ディレクトリとファイルは区別なく変更できます。
ユーザとグループの区切りに:を使うことも可能です。

オプション
-R
ディレクトリを対象にします。ディレクトリの中のディレクトリやファイルを再帰的にたどって変更します。



○実習: 一般ユーザとrootユーザでファイル所有者を変更


まず、一般ユーザでファイルを作成し、所有者の変更を試みます。
その後、rootユーザに移行し、所有者の変更を試みます。
ファイルの所有者が変更されているか確認してください。

$ touch user}
（ファイルを作成）
$ ls -l user}
（ファイルの所有者と所有グループを表示）
-rw-r--r-- 1 penguin linuc 0  2月  9 12:39 user
（現在の所有はユーザ penguin/linucグループ）
$ chown nobody user}
（一般ユーザでファイルの所有者を変更）
chown: `users' の所有権を変更中: 許可されていない操作です
（一般ユーザで変更不可エラー）
$ su}
（rootユーザへ移行）
パスワード: xxxxxxxx
（rootユーザのパスワード入力）
# chown nobody user}
（nobodyユーザへ所有者を変更）
# ls -l user}
-rw-r--r-- 1 nobody linuc 0  2月  9 12:39 user
（変更後の所有者を表示）


上の実行例では、所有者がpenguin、所有グループがlinucになっていますが、実際の環境ではコマンドを実行しているあなたのユーザとグループになります。

### 所有グループの変更

ファイルの所有グループを変更するにはchgrpコマンドを使って行ないます。

書式
chgrp グループ ディレクトリ
chgrp グループ ファイル


グループを変更できます。
ディレクトリとファイルは区別なく変更できます。

オプション
-R
ディレクトリを対象にします。ディレクトリの中のディレクトリやファイルを再帰的に変更します。



○実習: 一般ユーザとrootユーザでファイル所有グループを変更


一般ユーザでファイルを作成し、所有グループの変更を試みます。
その後、rootユーザに移行し、所有グループの変更を試みます。
ファイルの所有グループが変更されているか確認してください。

$ touch groups}
（ファイルを作成）
$ ls -l groups}
（ファイルの所有グループを表示）
-rw-r--r-- 1 penguin linuc 0  2月  9 12:39 groups
（現在の所有グループ）
$ chgrp nobody groups}
（一般ユーザでファイルの所有グループを変更）
chgrp: changing group of `groups': 許可されていない操作です	
（一般ユーザで権限の変更が不可であるとエラー表示）
$ su}
（rootユーザへ移行）
パスワード: xxxxxxxx
（rootユーザのパスワード入力）
# chgrp nobody groups}
（nobodyグループへ所有グループを変更）
# ls -l groups}
-rw-r--r-- 1 penguin nobody 0  2月  9 12:39 groups
（変更後の所有グループを表示）


## ファイルとアクセス権

ファイルはファイルを所有するユーザ、ファイル所有グループからファイル所有者を除いたユーザ、その他のユーザの3つのレベルで権限を設定できます。
ファイルにはユーザで分けた3つのレベルごとに読み、書き、実行の3つの権限があります。
ファイルのモードを変更するにはchmodコマンドを使います。

### ファイルに設定できるアクセス

ファイルのモードとしては読み書き実行の3つの権限があります。
所有ユーザ、所有グループで所有者以外のユーザ、所有グループ以外のユーザごとに3つの権限を設定できます。
lsコマンドに-lオプションを付けて表示される1つ目のカラムがファイルのモードを示しています。
モードを表す1つ目のカラムは次の様になります。

//indepimage[linuxtext2-img08][][latex::width=0.8\maxwidth]


//tsize[15,50]
//table[tbl12][ファイル種別のr,w,xの意味]{
項目	内容	
---------------------------------------------------------------------------
r	読み込み
w	書き込み
x	実行またはディレクトリの移動


rwxは、ユーザとグループとその他の3つに対して指定できます。rが表示されればファイルの読み込みが可能で、wが表示されればファイルの書き込みが可能です。xが表示されればファイルをプログラムとして実行できるか、または、ディレクトリであればディレクトリへ移動できます。


○実習: ファイル所有グループの確認


それでは、システムファイルのファイルモードを確認してみましょう。

$ ls -l .bashrc}
-rw-r--r-- 1 penguin linux 124  2月  6 02:44 .bashrc
（所有者が読み書き,所有グループが読み,その他が読み）
$ ls -l /usr}
合計 272
drwxr-xr-x   3 root root  4096  2月  6 01:45 X11R6
drwxr-xr-x   2 root root  4096  2月  8 13:07 arc
drwxr-xr-x   2 root root 69632  2月  9 04:02 bin
drwxr-xr-x   2 root root  4096  3月 30  2007 etc
drwxr-xr-x   2 root root  4096  3月 30  2007 games
drwxr-xr-x  84 root root 12288  2月  6 02:04 include
drwxr-xr-x   6 root root  4096 11月 11 11:39 kerberos
drwxr-xr-x 108 root root 69632  2月  7 11:41 lib
drwxr-xr-x  13 root root  4096  2月  9 04:02 libexec
drwxr-xr-x  11 root root  4096  2月  6 01:43 local
drwxr-xr-x   2 root root 16384  2月  7 11:41 sbin
drwxr-xr-x 226 root root 12288  2月  6 02:05 share
drwxr-xr-x   5 root root  4096  2月  6 08:52 src
lrwxrwxrwx   1 root root    10  2月  6 01:43 tmp -> ../var/tmp
（/usrディレクトリ以下のディレクトリは全てのユーザが読み込み可能で所有者(root)が書き込み可能）


### アクセス権の変更

ファイルのアクセス権を変更するにはchmodコマンドを使います。

書式
chmod モード[,モード]... ディレクトリ
chmod モード[,モード]... ファイル
chmod 8進数表記のモード ディレクトリ
chmod 8進数表記のモード ファイル


ファイルのモードを所有ユーザと所有グループとそれ以外のユーザについて設定します。
モード指定の書き方で次の2通りの記述方法があります。

 * モードの書式を複数書き、カンマで区切って指定。
 * 8進数3桁で各ユーザのレベルを指定。


オプション
-R
ディレクトリを対象にします。ディレクトリの中のディレクトリを再帰的に(ディレクトリの中にディレクトリがあれば、中のディレクトリを全てたどって)変更します。


//indepimage[linuxtext2-img06][][latex::width=0.8\maxwidth]


モードは次の様にu(所有ユーザ)、g(所有グループ)、o(その他のユーザ)に対して、r(読み)、w(書き)、x(実行またはディレクトリの変更)を設定したり(=)、加えたり(+)、取り消したり(-)します。u, g, o の全てに同じ権限を指定するときはaを指定します。


○実習: ファイルモードの変更


ユーザのファイルのモードを確認します。ファイルのモードを変更し、モードを再確認してください。
-rw-r--r--をrw-rw-r--としたい場合は、グループのw(書き込み権限)を加えたいのでg+wとします。
-rw-rw-r--を--w-rw-rw-としたい場合は、ユーザのr(読み込み権限)を取り除き、その他のw(書き込み権限)を加えたいのでu-r,o+wとします。
--w-rw-rw-を--w-rwxrwxとしたい場合は、グループとその他にx(実行権限)を加えたいのでgo+xとします。

$ touch chownfile}
（ファイルを作成）
$ chmod u+rw-x,go+r-wx chownfile}
（ファイルモードを「rw-r--r--」に変更）
$ ls -l chownfile}
-rw-r--r-- 1 penguin linuc 124  3月 27 19:09   chownfile
（ファイルモードを表示）

$ chmod g+w chownfile}
（グループにw(書き込み権限)を追加）
$ ls -l chownfile}
-rw-rw-r-- 1 penguin linuc 124  3月 27 19:09   chownfile
（ファイルモードを表示）
$ chmod u-r,o+w chownfile}
（ユーザからr(読み込み権限)を除去、その他にw(書き込み権限)を追加）
$ ls -l chownfile}
（ファイルモードを表示）
--w-rw-rw- 1 penguin linuc 124  3月 27 19:09   chownfile
$ chmod go+x chownfile}
（グループとその他にx(実行権限)を追加）
$ ls -l chownfile}
--w-rwxrwx 1 penguin linuc 124  3月 27 19:09   chownfile
（ファイルモードを表示）



○実習: ファイルモードを8進数で変更


ユーザのファイルのモードを確認します。ファイルのモードを変更し、モードを再確認してください。
-rw-rw-r--としたい場合は8進数の664を指定し、
--w-rw-rw-としたい場合は8進数の266を指定し、
--w-rwxrwxとしたい場合は8進数の277を指定してください。

$ touch chownfile}
（ファイルを作成）
$ chmod u+rw-x,go+r-wx chownfile}
（ファイルモードを「rw-r--r--」に変更）
$ ls -l chownfile}
-rw-r--r-- 1 penguin linuc 124  3月 27 19:09   chownfile
（ファイルモードを表示）

$ chmod 664 chownfile}
（ファイルモードを664に変更）
$ ls -l chownfile}
-rw-rw-r-- 1 penguin linuc 124  3月 27 19:09   chownfile
（ファイルモードを表示）

$ chmod 266 chownfile}
（ファイルモードを266に変更）
$ ls -l chownfile}
--w-rw-rw- 1 penguin linuc 124  3月 27 19:09   chownfile
（ファイルモードを表示）

$ chmod 277 chownfile}
（ファイルモードを277に変更）
$ ls -l chownfile}
--w-rwxrwx 1 penguin linuc 124  3月 27 19:09   chownfile
（ファイルモードを表示）


モードの指定にsetuidビットとsetgidビットとsticky(スティッキー)ビットという、特殊な属性があります。setuidビットあるいはsetgidビットが付いたプログラムを実行すると、ファイル所有者あるいは所有グループの権限で実行されます。具体的には、rootユーザ所有でsetuidビットがセットされたプログラムは、一般ユーザが実行した場合でもrootユーザが実行した場合と同じ動作をします

stickyビットが付いたディレクトリ内のファイルは所有者以外が削除できなくなります（Linuxでは、ファイルについてのスティッキービットは無視されます）。Linuxでは一般的に /tmp ディレクトリにスティッキービットが付与されています。


○実習: ファイルモードでsetuid/setgid/stickyの変更・確認


ユーザのファイルのモードで、setuidビットとsetgidビットとstickyビットを確認します。

$ touch idbitfile}
（ファイルを作成）
$ chmod u+rw-x,go+r-wx idbitfile}
（ファイルモードを「rw-r--r--」に変更）
$ ls -l idbitfile}
-rw-r--r-- 1 penguin linuc 0  3月 28 07:58 idbitfile
（ファイルモードを表示）

$ chmod u+s idbitfile}
（setuidビットを追加）
$ ls -l idbitfile}
-rwSr--r-- 1 penguin linuc 0  3月 28 07:58 idbitfile
（ファイルモードを表示）

$ chmod u-s,g+s idbitfile}
（setuidビットを除去、setgidビットを追加）
$ ls -l idbitfile}
-rw-r-Sr-- 1 penguin linuc 0  3月 28 07:58 idbitfile
（ファイルモードを表示）

$ chmod +t idbitfile}
（sticky(スティッキー)ビットを追加）
$ ls -l idbitfile}
-rw-r-Sr-T 1 penguin linuc 0  3月 28 07:58 idbitfile
（ファイルモードを表示）


### ファイル作成のモード

ファイルを新規に作成すると、ユーザごとに規定されたパーミッションである644、もしくは664といったパーミッションが設定されてファイルが作成されます。umaskコマンドを使うことで、指定したパーミッションでファイルを作成するように制限できます。

書式
umask [8進数のモードのマスク値]


### 現在のマスク値を表示

umaskコマンドに続けてマスク値を指定しなかった場合、現在のマスク値を表示できます。

### マスク値を変更

umaskコマンドに続けてマスク値を指定すると、コマンドを実行後に作成されるファイルが指定したパーミッションで作成できます。
umaskコマンドは許可しないビットを指定します。umaskコマンドで指定するマスク値は、すべてのユーザが読み書きできるパーミッション666から、設定したいパーミッションを引き算することでマスク値を求めることができます。

//indepimage[linuxtext2-img07][][latex::width=0.8\maxwidth]



○実習: umaskを変更してファイルを作成


umaskを変更後にファイルを作成したときに、作成したファイルのパーミッションが違っていることを確認します。

$ umask}
0022
（現在のマスク値を表示）

$ touch umask0022}
（ファイルを作成）
$ umask 070}
（マスク値を070に変更）
$ touch umask0070}
（ファイルを作成）
$ umask 072}
（マスク値を072に変更）
$ touch umask0072}
（ファイルを作成）
$ ls -l umask00*}
-rw-r--r-- 1 penguin linuc 0  3月 22 13:49 umask0022
-rw----rw- 1 penguin linuc 0  3月 22 13:50 umask0070
-rw----r-- 1 penguin linuc 0  3月 22 13:50 umask0072
（作成したファイルの権限を確認）


touchコマンドはモードが0666のファイルを作ろうとしますが、umaskによりマスクされるために上記のモードのようなファイルができます。
-Sオプションを付けると、モードを表示または設定するとき、8進数ではなく意味がわかりやすい形式を使用できます。

$ umask -S}
u=rwx,g=rx,o=rx
（現在のマスク値を表示）

$ touch umask0022}
（ファイルを作成）
$ umask -S u=rw,g=,o=rw}
u=rw,g=,o=rw
（マスク値を070に変更）
$ touch umask0070}
（ファイルを作成）
$ ls -l umask00*}
-rw-r--r-- 1 penguin linuc 0  3月 22 13:49 umask0022
-rw----rw- 1 penguin linuc 0  3月 22 13:50 umask0070
（作成したファイルのモードを確認）


umaskコマンドによるモードの制限は、umaskコマンドを実行したシェル内でしか有効でないことに注意してください。デフォルトのモードは.bashrc等のログインシェル内で設定することができます。

