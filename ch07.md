# ファイルのアクセス制御
LinuxはマルチユーザーのOSなので、ファイルに対するアクセス制御が必要です。アクセス制御とは、あるファイルやディレクトリに対して、アクセスを許可したり、許可しないようにする仕組みです。
アクセス制御は、ファイルに対する所有者や所有グループを設定し、それぞれに対するアクセス権を設定することで実現しています。
本章では、ファイルのアクセス制御を行うためのユーザー権限とアクセス権について解説します。

## ファイルの所有者と所有グループ
ファイルを作成すると、ファイルの所有者は作成したユーザーに設定されます。また、所有グループは作成したユーザーのプライマリーグループが設定されます。

### 所有者と所有グループの確認
所有者、所有グループは、lsコマンドに-lオプションをつけて実行すれば確認できます。

touchコマンドでtestファイルを作成し、所有者と所有グループを確認します。

$ touch test
$ ls -l test
-rw-r--r--. 1 linuc linuc 0  8月 16 10:44 test

一番左がアクセス権です。3番目の項目が所有者、4番目の項目が所有グループです。

### 所有者の変更
ファイルの所有者を変更するにはchownコマンドを使います。指定方法によって所有グループも変更できます。

書式
chown [オプション] [ユーザー][:[グループ]] ファイル

オプション
-R
ディレクトリを対象に、ディレクトリの中のファイルやディレクトリを再帰的に変更します。

ユーザーとグループを変更するには、root権限が必要です。

新しい所有者は、以下のパターンで指定できます。

- 所有者を変更
chown ユーザー ファイル

- 所有者と所有グループを変更
chown ユーザー:グループ ファイル

- 所有グループを変更
chown :グループ ファイル

作成したtestファイルの所有者を変更します。一般ユーザーでは所有者は変更できません。sudoコマンドを使ってroot権限でchownコマンドを実行します。

$ chown sato test
chown: 'test' の所有者を変更中: 許可されていない操作です
$ sudo chown sato test
$ ls -l test
-rw-r--r--. 1 sato linuc 0  8月 16 10:44 test
$ rm test
rm: 書き込み保護されたファイル 通常の空ファイル 'test' を削除しますか?y

testファイルの所有者をユーザーsatoに変更できました。最後にファイルを削除しようとすると、所有者が異なるファイルを削除しようとしているため、確認が必要となります。

### 所有グループの変更
ファイルの所有グループを変更するにはchgrpコマンドを使います。

書式
chgrp グループ ファイル

オプション
-R
ディレクトリを対象に、ディレクトリの中のファイルやディレクトリを再帰的に変更します。

一般ユーザーは、自分が所属しているグループを所有グループとして指定できます。sudoコマンドを使ってroot権限でchgrpコマンドを実行することで、すべてのグループを所有グループとして指定できます。

$ id
uid=1000(linuc) gid=1000(linuc) groups=1000(linuc),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
$ mkdir testdir
$ chgrp wheel testdir
$ ls -ld testdir
drwxr-xr-x. 2 linuc wheel 6  8月 16 10:57 testdir
$ chgrp kvm testdir
chgrp: 'testdir' のグループを変更中: 許可されていない操作です

サブグループとして所属しているwheelグループを所有グループに変更できましたが、所属していないkvmグループには変更できませんでした。

## ファイルとアクセス権
ファイルへのアクセス権のことを「モード」や「パーミッション」とも呼びます。
ファイルのアクセス権には「読み込み（Read）」「書き込み（Write）」「実行（eXecute）」の3つの種類があります。このアクセス権を、所有者、所有グループ、その他のユーザーの3つに対してそれぞれ設定できます。
ファイルのモードを変更するにはchmodコマンドを使います。

### アクセス権を確認する
ファイルのモードは、lsコマンドに-lオプションをつけて実行すれば確認できます。
一番左がファイルのモードを示しています。

//indepimage[linuxtext2-img08][][latex::width=0.8\maxwidth]

r,w,xの意味
| 項目 | 内容	
|-|-
| r | 読み込み
| w | 書き込み
| x | 実行、またはディレクトリ内に入れる

rwxは、所有者と所有グループ、その他のユーザーの3つに対して指定できます。
rが設定されているとファイルやディレクトリの読み込みが可能、wが設定されているとファイルやディレクトリへの書き込みが可能です。xが設定されているとファイルをプログラムとして実行できるか、ディレクトリであればディレクトリに入れます。

### アクセス権の変更
ファイルのアクセス権を変更するにはchmodコマンドを使います。

書式
chmod モード[,モード]... ファイル
chmod 8進数表記のモード ファイル

オプション
-R
ディレクトリを対象に、ディレクトリの中のファイルやディレクトリを再帰的に変更します。

モードの指定は2通りの記述方法があります。

- ユーザー種別毎のモード書式をカンマで区切って指定
- 8進数3桁でまとめて指定

//indepimage[linuxtext2-img06][][latex::width=0.8\maxwidth]

### モード書式によるアクセス権の設定
モードは「u」(所有ユーザー)、「g」(所有グループ)、「o」(その他のユーザー)に対して、「r」(読み)、「w」(書き)、「x」(実行またはディレクトリの変更)を「設定したり(=)」、「加えたり(+)」、「取り消したり(-)」します。u, g, o の全てに同じ権限を指定するときはaを指定します。


$ touch test
$ ls -l test
-rw-r--r--. 1 linuc linuc 0  8月 16 14:24 test
$ chmod g+w test
$ ls -l test
-rw-rw-r--. 1 linuc linuc 0  8月 16 14:24 test

$ ls -ld testdir
drwxr-xr-x. 2 linuc wheel 6  8月 16 14:25 testdir
$ chmod g+w,o+w testdir
$ ls -ld testdir
drwxrwxrwx. 2 linuc wheel 6  8月 16 14:25 testdir

### 8進数によるアクセス権の設定
8進数によるアクセス権の設定は、設定したいアクセス権を8進数に置き換え、3桁で指定します。

たとえば、「-rw-r--r--」と指定する場合、rは4、wは2なので「644」となります。「rwxr-xr-x」と指定する場合、xは1なので「755」となります。

ファイルのアクセス権を指定してみます。

$ ls -l test
-rw-rw-r--. 1 linuc linuc 0  8月 16 14:24 test
$ chmod 644 test
$ ls -l test
-rw-r--r--. 1 linuc linuc 0  8月 16 14:24 test

「644」と指定したので、アクセス権は「-rw-r--r--」となりました。

ディレクトリのアクセス権を指定してみます。

$ ls -ld testdir
drwxrwxrwx. 2 linuc wheel 6  8月 16 14:25 testdir
$ chmod 755 testdir/
$ ls -ld testdir
drwxr-xr-x. 2 linuc wheel 6  8月 16 14:25 testdir

「755」と指定したので、「rwxr-xr-x」となりました。

### アクセス権変更によるアクセス制御の確認
アクセス権を変更して、アクセス制御が行われるところを確認します。

ファイルに書き込み可能な状態で、catコマンドを使って文字列を書き込みます。

$ ls -l test
-rw-rw-r--. 1 linuc linuc 0  8月 16 14:24 test
$ cat > test
Write Test.
$ cat test
Write Test.

所有者に対する書き込みのアクセス権を無くして、書き込みができなくなることを確認します。

$ chmod u-w test
$ ls -l test
-r--rw-r--. 1 linuc linuc 12  8月 16 18:10 test
$ cat > test
-bash: test: 許可がありません

ディレクトリに書き込み可能な状態で、touchコマンドでtestファイルを作成します。

$ ls -ld testdir
drwxr-xr-x. 2 linuc wheel 6  8月 16 14:25 testdir
$ touch testdir/test
$ ls -l testdir
合計 0
-rw-r--r--. 1 linuc linuc 0  8月 16 18:21 test

ディレクトリに対する書き込みのアクセス権を無くして、書き込みができなくなることを確認します。

$ chmod 555 testdir
$ ls -ld testdir
dr-xr-xr-x. 2 linuc wheel 18  8月 16 18:21 testdir
$ touch testdir/test2
touch: 'testdir/test2' に touch できません: 許可がありません

