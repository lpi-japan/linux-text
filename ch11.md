= ファイル管理

ファイルシステムの説明を読みながら、ファイルシステムの管理コマンドに慣れることで、ファイルシステムの概念と管理操作を身に付けます。
ファイルシステムの構造を把握するために説明するのはext3ファイルシステムにおけるファイルとディレクトリ、iノード、リンクという用語です。
用語を理解するために、dfコマンド、duコマンド、fdiskコマンド、fsckコマンド、mountコマンド、umountコマンドに加え、lnコマンドを実行します。

## Linuxのファイル管理

Linuxのファイル管理にはハードディスクとファイルシステムとディレクトリ構造の知識が必要となります。
ハードディスクをLinuxで利用するために、ファイルシステムについて知ることが望ましく、コマンドで準備作業が必要です。
利用目的に応じてファイルシステムを選び、コマンドでファイルシステムを準備する作業が必要となります。
ディレクトリの階層標準を初めとする、ディレクトリに関する知識と状態を調べるコマンドを、習得しましょう。

### ファイルシステムとは

ファイルシステムとは、ファイル名・更新日付などの属性データ・ファイルデータ本体を効率よく管理するためのしくみです。ファイルシステムにはいくつか種類があり、利用するファイルシステムにより、ファイルをアクセスした時に得られる効率や安全性が変わります。ファイルシステムの概要をつかむと、今までに出てきたコマンドの理解度も上がるでしょう。

### パーティションとは

ハードディスクを利用するために、ハードディスクを区切った単位です。ディスクの内部を複数のパーティション（領域）に区切る作業が必要となります。パーティションを分割する作業をパーティショニングと呼びます。

### Linuxのディレクトリ構造

ファイル単位でデータを管理すると段々とファイル数が多くなり、ファイル名の管理が難しくなります。ファイル管理の効率化を図るために、多くのファイルシステムと同様にext3ファイルシステムでも、ディレクトリという入れ物が用意されています。ディレクトリは複数のファイルをまとめて管理できる上に、他のディレクトリもまとめられます。ディレクトリを使うと、利用目的ごとにファイルをまとめたり、幾つかのディレクトリをディレクトリに入れて管理できるでしょう。Linuxを始めとするLinuxのディレクトリ構造は/ディレクトリが大元になるツリー状となっています。

### /ディレクトリ

大元になるディレクトリで”/”をルートと読み、/ディレクトリをルートディレクトリと読みます。
/ディレクトリにディレクトリやファイルが入ります。

### マウント

ディスク(ハードディスクを始めとしてDVD-ROMドライブやRAMディスクなど)を利用するためには1つ目を/ディレクトリに必ずマウントします。
複数のディスクを利用する場合は、2つ目以降のディスクを既にマウントされているディスクの中のディレクトリにマウントします(既に中身があるディレクトリにディスクをマウントすると、マウントされたディレクトリが/ディレクトリであっても中身は置き換わり、今まであったディレクトリの中身は読み書きできなくなります)。

###[column] FHS(Filesystem Hierarchy Standard)
ファイルは必ずディレクトリに入るので、必ず/ディレクトリから始まる記述ができます。
LinuxシステムはFHSと呼ばれる規格に基づいてディレクトリの構成が定められています。一般ユーザ用プログラムはbinディレクトリ、システム管理用プログラムはsbinディレクトリ、設定ファイルはetcディレクトリ、複数のプログラムで共通に使われるライブラリはlibディレクトリ、可変的なデータ（ログ・データベース・ウェブサイトなど）は var ディレクトリという緩やかな決まりがあります。
/usrディレクトリの下にも同じ構成のディレクトリがあり、ユーザが独自にインストールするファイルは/usr/localディレクトリの下に置く場合もあるでしょう。
上記のディレクトリのほか、起動関連のファイルが格納されるbootディレクトリ、デバイスファイルが格納されるdevディレクトリ、ユーザの作業領域が格納されるhomeディレクトリ、一時ファイルが格納されるtmpディレクトリなどがFHSで定められているディレクトリとしてあげられます。

//indepimage[linuxtext2-img16][][latex::width=0.8\maxwidth]



###[/column]


### ファイルシステムの作成方法

ハードディスクを利用するには以下の手順で作成して利用できます。

 * パーティションの作成・・・fdiskコマンド
 * ファイルシステムの作成・・・mkfsコマンド
 * マウント・・・mountコマンド
以降に出てくるコマンドは/sbinディレクトリにあるシステム管理用のコマンドです。多くのシステム管理用のコマンドはrootユーザで(管理者になってから)実行する必要があります。

一般ユーザはシステム管理の権限がないため、システム管理用のコマンドを実行できなかったり、システム管理用のコマンドを実行できても必要な資源(ハードディスクなど)にアクセスできなかったりします。また、一般ユーザの初期設定では、システム管理用のコマンドが置いてある/sbinディレクトリがPATHの設定に含まれていないため、/sbin/fdiskの様に絶対パス(/ディレクトリからの指定)でコマンドを実行する必要があります。
本教科書の実行例で、行頭が#になっているコマンドはrootユーザでの作業が必要です。一般ユーザのときはsu -コマンドでrootユーザになってからコマンドを実行してください。
コマンドの詳しい内容は後ほど説明します。

$ su -
パスワード: xxxxxxx
（rootのパスワードを入力）
#
（rootユーザに切り替わる）



## ディスクのパーティション

fdiskコマンドで、分割されたパーティションの情報を調べたり、パーティションを作成、削除したりできます。

### パーティション分割する理由

パーティションを分割するのは以下の理由があります。

 * システムとデータのバックアップ頻度を差別化する
 * 障害発生時の影響範囲を狭める
 * ファイルアクセスの速度向上


書式
fdisk [オプション] [デバイスファイル]
ディスクの構造を表示します。
ディスクをパーティション分割します。


オプション
-l
デバイスのパーティション情報を表示します。



○実習: ハードディスクのパーティション情報の表示


fdiskコマンドを実行して現在認識されているハードディスクのパーティション情報を表示しましょう。
以下の例のようにコマンドを実行してみてください。

# fdisk -l} 
（ハードディスクのパーティションを表示）
ディスク /dev/sda: 6442 MB, 6442450944 バイト
ヘッド 255 , セクタ 63 , シリンダ 783
Units = シリンダ数 of 16065 * 512 = 8225280 バイト
（略）
デバイス ブート      始点        終点     ブロック  Id システム 
/dev/sda1   *           1         587     4715046   83  Linux
/dev/sda2             588         783     1574370   82  Linux swap / Solaris
（2つのデバイス情報が表示される）


fdiskコマンドで表示された情報から、ここでは接続されているハードディスクのデバイス名は/dev/sda1と/dev/sda2の2つです。1つ目のハードディスク(sda)が2つに分割されているのがわかります。1つめのパーティションは4715046ブロック(4.5Gバイト)でIDが83(Linux用)、2つ目のハードディスクは1574370ブロック(1.5Gバイト)でIDが82(スワップ用)です。

//indepimage[linuxtext2-img14][][latex::width=0.8\maxwidth]



### パーティションの分割

コンピュータのハードディスクとして主にSATAとSASの2つのインターフェース(周辺機器を接続するためのハードウェア)規格が広く使われています。
ハードディスクは、1つのパーティションとして使うか、2～4つまでのパーティションに分割できます。各パーティションは、基本パーティションまたは拡張パーティションとなります。拡張パーティションは1台のハードディスクに1つだけ作ることができ、拡張パーティションの中には、さらに論理パーティションを複数作ることができます。

### パーティション分割の例

 * 基本パーティションを4つ
 * 基本パーティションを3つ＋拡張パーティションを1つ(論理パーティションを2つ)
 * 論理パーティションは、基本パーティションと同様にファイルシステムを作成して、ファイルやディレクトリを保管できます。拡張パーティションは、論理パーティションを格納する役割となっており、ファイルシステムを作成することはできません。

### パーティションの最大数

 * IDE：63（基本3＋論理60）
 * SATA：15（基本3＋論理12）
 * SCSI：15（基本3＋論理12）

Linuxでは4つ以上のパーティションが必要となるケースが多いので、拡張パーティション1つと他の3つを基本パーティションという構成で使う場合が多くなります。また、拡張されたハードディスクは基本パーティション1つや、LVM(Logical Volume Managemer)機能を使って複数のハードディスクを統合した1つのハードディスクとして大きく使うことも多いでしょう。

### ハードディスクを増設して利用可能にする

Linuxマシンにハードディスクを増設して利用可能な状態にします。新しいハードディスクには、データ用の領域と、スワップ領域(Linuxがメモリの代わりにプログラムを置いておく領域)の2つを作成します。
利用可能にするには、fdiskコマンドでパーティションを2つに分割します。
パーティションは分割した後からサイズ等の変更が難しいので、あらかじめどのようにパーティションを分割するのか計画してから行ないます。また、既に使用しているハードディスクのパーティションを操作すると、大切なデータが消えてしまいますので、細心の注意を払って進めてください。
パーティションを分割する作業をしているときに、指定サイズや分割数の設定ミスに気づいたら、パーティションの変更を保存しないで直ちに終了してください。

パーティションの操作はシステム管理の仕事なので、rootユーザでfdiskコマンドを実行する必要があります。可能であれば、他のユーザがシステムを利用できないランレベル1(ハードディスクの管理をするときに指定するモードで、管理者のみがコマンドを実行。通常はランレベル3やランレベル5で動作)の状態で作業をしてください。

### ハードディスクを利用するまでの手順

 1. 増設前のデバイス構成の確認
 1. ハードディスクを増設
 1. 増設後のデバイス構成の確認
 1. パーティション情報の確認
 1. パーティションの作成
 1. パーティションの種類の変更
 1. パーティション情報の保存
 1. 再起動（警告が表示されて、必要な場合）
 1. ファイルシステムの作成
 1. マウント
 1. スワップパーティションの作成
 1. スワップの追加
 1. 自動マウントの設定

○実習: 増設前のデバイス構成の確認


まず、ディスクを増設する前のデバイスの構成を確認します。
以下のコマンドを実行して確認してみましょう。

$ ls -l /dev/sd*}
brw-rw----. 1 root disk      8,   0  6月 20 11:09 2012 sda
brw-rw----. 1 root disk      8,   1  6月 20 11:09 2012 sda1
brw-rw----. 1 root disk      8,   2  6月 20 11:09 2012 sda2
brw-rw----. 1 root disk      8,  16  6月 20 11:09 2012 sdb
brw-rw----. 1 root disk      8,  17  6月 20 11:09 2012 sdb1


/devディレクトリはLinuxが認識するすべてのデバイスが置かれています。
このうち、hd*もしくはsd*のような名前がついているデバイスがハードディスクドライブになります。

数字無しのデバイスはディスクドライブ自体を示しています。このことから、このシステムには2つのハードディスクドライブが認識されていることがわかります。数字付きのデバイスはハードディスクドライブが認識する、ファイルシステムを示します。sdaには2つのパーティションが存在し、sdbには1つのパーティションが存在することがわかります。


○実習: ハードディスクを増設


CentOSをシャットダウンして、新しいハードディスクを増設します。
増設したハードディスクは新しいデバイスとして認識されます。

ハードディスクは増設しただけでは利用できません。このあと以下の作業を行ないます。

 * fdiskでパーティションを設定
 * Physical Volumeの作成
 * mkfsコマンドを実行してディスク作成
 * マウントおよび自動マウントの設定


○実習: 増設後のデバイス構成の確認


ハードディスクを増設したらデバイスとして認識されているか、以下のコマンドを実行して確認してみましょう。

$ ls -l /dev/sd*}
brw-rw----. 1 root disk      8,   0  6月 20 11:09 2012 sda
brw-rw----. 1 root disk      8,   1  6月 20 11:09 2012 sda1
brw-rw----. 1 root disk      8,   2  6月 20 11:09 2012 sda2
brw-rw----. 1 root disk      8,  16  6月 20 11:09 2012 sdb
brw-rw----. 1 root disk      8,  17  6月 20 11:09 2012 sdb1
brw-rw----. 1 root disk      8,  32  6月 20 11:09 2012 sdc


増設したハードディスクが、デバイス/dev/sdcとして追加・認識されました。


○実習: パーティション情報の確認


fdiskコマンドに/dev/sdcデバイスを指定して起動します。pコマンドで現在のパーティション情報を表示できます。パーティションが分割されていないハードディスクであれば何も表示されません。パーティションの分割がされていてもパーティションとして確保していない場所があれば、新たなパーティションを作成することができます。

# fdisk /dev/sdc}
コマンド (m でヘルプ): p}          現在のパーティション情報を表示

ディスク /dev/sdc: 6442 MB, 6442450944 バイト
ヘッド 255 , セクタ 63 , シリンダ 783
Units = シリンダ数 of 16065 * 512 = 8225280 バイト
（略）
デバイス ブート      始点        終点     ブロック  Id システム

                                        分割されていない状態で何も表示されない



○実習: パーティションの作成


nコマンドで新しいパーティションを確保します。
コマンドアクションではpを指定して、基本パーティションを2つ作成します。
パーティションの先頭シリンダ番号と、パーティションのサイズを指定します。
パーティションを確保したら、pコマンドで確保されたパーティションを確認してください。

# fdisk /dev/sdc}

コマンド (m でヘルプ): m}
（ヘルプを表示）

コマンドの動作
   a   ブート可能フラグをつける
   b   bsd ディスクラベルを編集する
   c   dos 互換フラグをつける
   d   領域を削除する
   l   既知の領域タイプをリスト表示する
   m   このメニューを表示する
   n   新たに領域を作成する
   o   新たに空の DOS 領域テーブルを作成する
   p   領域テーブルを表示する
   q   変更を保存せずに終了する
   s   空の Sun ディスクラベルを作成する
   t   領域のシステム ID を変更する
   u   表示/項目ユニットを変更する
   v   領域テーブルを照合する
   w   テーブルをディスクに書き込み、終了する
   x   特別な機能 (エキスパート専用)

コマンド (m でヘルプ): n}
（新しいパーティション領域の確保）

コマンドアクション
   e   拡張
   p   基本パーティション (1-4)
p}															
（pを入力して基本パーティションを作成）

パーティション番号 (1-4): 1}							
（初めてパーティションを作成するので1）

最初 シリンダ (1-783, default 1): 1}
（デフォルトの先頭シリンダを指定）

Last シリンダ,+シリンダ数 or +size(K,M,G) (1-783,初期値 783): +1024M}
（確保するサイズ）

コマンド (m でヘルプ): n}
（新しいパーティションの確保）

コマンドアクション
   e   拡張
   p   基本パーティション (1-4)
p}
（基本パーティションを作成）

パーティション番号 (1-4): 2}
（2つ目のパーティションを作成するので2）

最初 シリンダ (126-783, default 126): 126}
（先頭シリンダを指定）

Last シリンダ,+シリンダ数 or +size(K,M,G) (126-783,初期値 783): +1024M}
（確保するサイズ）

コマンド (m でヘルプ): p}
（現在のパーティション情報を表示）
ディスク /dev/sdc: 6442 MB, 6442450944 バイト
ヘッド 255 , セクタ 63 , シリンダ 783
Units = シリンダ数 of 16065 * 512 = 8225280 バイト
（略）
デバイス ブート      始点        終点     ブロック  Id システム 
/dev/sdc1               1         125     1004031   83  Linux
/dev/sdc2             126         250     1004062+  83  Linux
（確保したパーティションがリスト表示される）


シリンダを指定する箇所が2箇所あります。パーティションの分割は途中を空けないで連続して指定するので、最初シリンダの数はデフォルトのシリンダ数をそのまま使えます。終点シリンダの数の代わりに+を付けたサイズを指定できます。シリンダ数を計算して指定するなどの面倒な作業は必要ないので、ここではシリンダ数に関しては考慮する必要がありません。


○実習: パーティションの種類の変更


パーティションは、その使用目的によって種類が指定されています。
確保したばかりのパーティションは、Linuxのファイルシステム用であるIdの83(Linux用）が指定されています。
スワップとして利用するためには、tコマンドで種類を変更してください。
スワップパーティションとして利用するには、IDに82(スワップ用)を指定します。
指定できる種類は、種類を設定する途中で、Lコマンドを使って一覧表示できます。

コマンド (m でヘルプ): t}		       （確保したパーティションの情報を変更）
パーティション番号 (1-4): 2}
16進数コード (L コマンドでコードリスト表示): L}  （パーティションの種類のリスト表示）
 0  空              1e  Hidden W95 FAT1 80  古い Minix    　be  Solaris boot
 1  FAT12           24  NEC DOS         81  Minix / 古い  　bf  Solaris
 2  XENIX root      39  Plan 9          82  Linux swap / So c1  DRDOS/sec (FAT-
 3  XENIX usr       3c  PartitionMagic  83  Linux           c4  DRDOS/sec (FAT-
 4  FAT16 <32M      40  Venix 80286     84  OS/2 隠し C:  　c6  DRDOS/sec (FAT-
 5  拡張パーティション 41  PPC PReP Boot   85  Linux 拡張領 　 c7  Syrinx
 6  FAT16           42  SFS             86  NTFS ボリュ  　 da  非 FS デー
 7  HPFS/NTFS       4d  QNX4.x          87  NTFS ボリュ  　 db  CP/M / CTOS / .
 8  AIX             4e  QNX4.x 2nd part 88  Linux plaintext de  Dell ユーテ
 9  AIX ブート   　 4f  QNX4.x 3rd part 8e  Linux LVM       df  BootIt
 a  OS/2 ブート  　 50  OnTrack DM      93  Amoeba          e1  DOS access
 b  W95 FAT32       51  OnTrack DM6 Aux 94  Amoeba BBT      e3  DOS R/O
 c  W95 FAT32 (LBA) 52  CP/M            9f  BSD/OS          e4  SpeedStor
 e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a0  IBM Thinkpad    eb  BeOS fs
 f  W95 Ext'd (LBA) 54  OnTrackDM6      a5  FreeBSD         ee  EFI GPT
10  OPUS            55  EZ-Drive        a6  OpenBSD         ef  EFI (FAT-12/16/
11  隠し FAT12    　56  Golden Bow      a7  NeXTSTEP        f0  Linux/PA-RISC
12  Compaq 診断   　5c  Priam Edisk     a8  Darwin UFS      f1  SpeedStor
14  隠し FAT16 <3 　61  SpeedStor       a9  NetBSD          f4  SpeedStor
16  隠し FAT16    　63  GNU HURD また 　ab  Darwin boot     f2  DOS セカン
17  隠し HPFS/NTF 　64  Novell Netware  b7  BSDI fs         fd  Linux raid 自
18  AST SmartSleep  65  Novell Netware  b8  BSDI スワッ  　 fe  LANstep
1b  Hidden W95 FAT3 70  DiskSecure Mult bb  隠し Boot Wiz 　ff  BBT
1c  Hidden W95 FAT3 75  PC/IX

16進数コード (L コマンドでコードリスト表示): 82}
（スワップ領域を指定）
Changed system type of partition 2 to 82 (Linux swap / Solaris)



○実習: パーティション情報の保存


パーティション情報は、wコマンドでハードディスクに書き込むと変更されます。パーティション情報の再読込が行えなかった場合には、警告が表示されるので、システムを再起動してください。

パーティション情報をハードディスクへ書き込まないで、パーティションの変更を破棄したい場合には、fdiskをqコマンドで終わらせます。

コマンド (m でヘルプ): w}
（ハードディスクにパーティション情報を書き込む）

The partition table has been altered!
Calling ioctl() to re-read partition table.
WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table.
The new table will be used at the next reboot.
Syncing disks.
（ワーニングメッセージは出ますが、書込みは終了できます）
コマンド (m でヘルプ): q}


### コマンド	意味

 * w	=書き込み、保存(write)
 * q=変更を書き込まない、破棄(quit)


## ファイルシステム

ファイルシステムとは、ディレクトリやファイルの情報やデータをディスクの何処に保存してあるか管理するためのシステム(仕組み)です。
ファイルシステムはディレクトリやファイルの、ファイル名やファイルの作成時間やファイルの所有権限などの情報を管理しています。また、ディスクのデータが書いてある場所とデータが書いていない場所なども管理しています。

ファイルシステムはオペレーティングシステムによって利用されるファイルシステムが異なります。Linuxの場合はそれぞれのディストリビューションにより採用するファイルシステムは異なりますが、多くの場合はext3もしくはext4が利用されています。Windowsの場合はバージョンは異なるものの多くの領域を管理できるNTFSが利用されている事がほとんどでしょう。CDやDVD、BDではISO9660という規格のファイルシステムが使われます。

各オペレーティングシステムで利用できるファイルシステムは以下の通りです@<fn>{fn1}。

//tsize[20,60,25,25]
//table[tbl25][Linuxで利用できるファイルシステムの一例]{
FS名	内容	最大サイズ	最大ファイルサイズ
---------------------------------------------------------------------------
ext2	Berkeley Fast File Systemを参考にした16ビット構造	16TB	2TB
ext3	ext2にジャーナル機能付加と機能拡張	2～32TB	16GB～2TB
ext4	ジャーナリングファイルシステム。ファイルの断片化防止などさまざまな機能拡張によりパフォーマンスが向上	1EB	16TB
ReiserFS	小さなファイルの扱いに向いたジャーナリングファイルシステム	8TB	16TB
XFS	SGI社が提供したジャーナリングファイルシステム	8EB	8EB
JFS	IBM社が提供したジャーナリングファイルシステム	512TB	4PB～8EB


//tsize[20,60,25,25]
//table[tbl26][Windowsで利用できるファイルシステムの一例]{
FS名	内容	最大サイズ	最大ファイルサイズ
---------------------------------------------------------------------------
FAT16	セクタという領域を1次元配列で管理するファイルシステム。現在は使われない	2GB(NT:4GB)	2GB(NT:4GB)
FAT32	セクタという領域を1次元配列で管理するファイルシステム。外付ディスクなどで使われており、Windows以外でも利用できる	2TB(2KBセクタ:8TB)	4GB
NTFS	NT/XP/Vista用ジャーナリングファイルシステム	256TB	16TB(16EB)
exFAT	フラッシュメディア向けファイルシステム	8ZB(512Bセクタ時)	16TB(16EB)


//tsize[20,60]
//table[tbl27][CD/DVDのファイルシステム]{
FS名	内容
---------------------------------------------------------------------------
ISO9660	ISO(国際標準化機構)で標準化されたファイルシステム、JolietやRockRidgeやAppleの規格拡張が存在、CDやDVDに利用される



//footnote[fn1][容量の単位:@<br>{}1M(メガ) バイト=1024K バイト    1G(ギガ) バイト=1024M バイト@<br>{}1T(テラ) バイト=1024G バイト    1P(ペタ) バイト=1024T バイト@<br>{}1E(エクサ) バイト=1024P バイト   1Z(ゼタ) バイト=1024E バイト]

以降の解説ではext3/4の主要機能を解説します。

### ジャーナリング機能

ジャーナリングとは、ファイルシステムに対する書き換え処理のコマンドをファイルシステムに逐一記録する機能です。ジャーナリング機能はコンピュータが急停止するなどの障害時に有効となるでしょう。コンピュータが急停止し、ファイルのデータがファイルシステムに書き込み途中である場合、処理されていないコマンドを対処します。ファイルの書き込み途中の場合、書き込み終わっていないデータが無くて書き込みを終われないので、途中までディスクに保存されているファイルの管理情報を消し、書き込み途中のファイルが作られなかった状態にします。
ext3ファイルシステム以降のファイルシステムの多くはこのジャーナリング機能を取り入れています。ext3ファイルシステムは、ext2ファイルシステムにジャーナリング機能＋αが追加されたファイルシステムです。ext3のほかに、ReiserFS、XFS、JFSもジャーナリング機能を持ったファイルシステムです。

### マウント状態の表示

dfコマンドで現在マウントされているファイルシステムのリストを表示できます。


○実習: ハードディスクの確認


それでは実際にdfコマンドを実行し、動きを見てみましょう。

# df}
（マウントされているファイルシステムの一覧表示）
Filesystem           1K-ブロック    使用   使用可 使用% マウント位置
/dev/sda1              4567236   3395908    935576  79% /
tmpfs                   517660         0    517660   0% /dev/shm
/dev/hdc               3630332   3630332         0 100% /media/cdrom


sdaハードディスクの1つ目のパーティションである/dev/sda1が/ディレクトリに、tmpfsという特殊デバイスが/dev/shmディレクトリに、DVD-ROMの/dev/hdcが/media/cdromにマウントされています。

### ファイルシステムの作成

ハードディスクを利用するためには、パーティションに分割した後ファイルシステムを作成します。
ファイルシステムの作成にはmkfsコマンドを使用します。

書式
mkfs オプション

ファイルシステムを作成します。

オプション
-t
作成するファイルシステムの種類を指定する。

-c
ハードディスクの壊れている箇所を検出して、利用しない。



○実習: ハードディスクの作成


mkfsコマンドを実行してハードディスクを作成してみましょう。
以下の例のようにコマンドを実行してみてください。

### sdc1(3つ目のインターフェースの1つ目のパーティション)にext3形式のファイルシステムを作成

# mkfs -t ext3 -c /dev/sdc1}
mke2fs 1.39 (29-May-2006)      
Filesystem label=opt
（ハードディスクのラベル）
OS type: Linux
Block size=4096 (log=2)
（ハードディスクのパーティションのサイズ）
Fragment size=4096 (log=2)
70400 inodes, 140568 blocks
7028 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=146800640
5 block groups
32768 blocks per group, 32768 fragments per group
14080 inodes per group
Superblock backups stored on blocks:
        32768, 98304
Checking for bad blocks (read-only test): done
Writing inode tables: done
Creating journal (4096 blocks): done
Writing superblocks and filesystem accounting information: done
This filesystem will be automatically checked every 22 mounts or
180 days, whichever comes first.  Use tune2fs -c or -i to override.


### ラベル

ラベルとは、ハードディスクなどのパーティションを認識するための名前です。
基本パーティションや論理パーティションにファイルシステムを作るときにラベルを指定するか、またはe2labelコマンドでラベルを付けられます。

書式
e2label デバイス [ラベル]
パーティションのラベルを表示します。
パーティションのラベルを付けます。



○実習: e2labelコマンドでハードのラベル名を変更


e2labelコマンドにデバイスを指定するとラベルを確認できます。
e2labelコマンドにデバイスとラベルを指定するとデバイスのラベルを変更できます。

# e2label /dev/sda1}
/1
（/dev/sda1のラベルを表示）

# e2label /dev/sdc3}
opt
（/dev/sdc3のラベルを表示）

# e2label /dev/sdc3 opt2}
（/dev/sdc3のラベルをopt2に変更）

# e2label /dev/sdc3}
opt2
（/dev/sdc3のラベルを表示）


## マウント

ハードディスクはパーティション分割してファイルシステムを作ってからマウントすると読み書きできます。
CD-ROMやDVD-ROMなどのリムーバブルメディアもマウントすると読めるようになります。

### マウントポイント

ハードディスクやCD-ROMなどを利用する場合は、存在しているディレクトリにマウントする必要があり、マウントするために利用するディレクトリをマウントポイントと呼びます。
/として利用されるファイルシステムは/にマウントされており、後から利用するファイルシステムも、必ずどこかのディレクトリにマウントして初めて利用できます。

### マウント（mountコマンド）

ハードディスクやリムーバブルメディアなどをマウントポイントにマウントするためにmountコマンドを使います。

書式
mount -t タイプ -o オプション デバイスファイル マウントポイント
ハードディスクやリムーバブルメディアをマウントします。


オプション
-t タイプ
ファイルシステムのext3やWindowsのmsdos、CDとDVDのiso9660など

-o オプション
読み書きのrwや読み取り専用のroなど

デバイスファイル
ファイルシステムをアクセスするためのデバイスファイル

マウントポイント
マウントするディレクトリ


### アンマウント（umountコマンド）

マウントされたハードディスクやリムーバブルメディアを利用しなくなると、アンマウントします。アンマウントするためにumountコマンドを使います。

書式
umount マウントポイント
ハードディスクやリムーバブルメディアをアンマウントします。



○実習: ハードディスクのパーティションのマウント


mountコマンドでsdc2(3つ目のドライブの2つ目のパーティション)を/optディレクトリへマウントしてください。ファイルシステムが、読み書きできるようにrwオプションを付けました。

マウントしているファイルシステムはlsコマンドおよびdfコマンドで確認できます。

# mount -t ext3 -o rw /dev/sdc2 /opt}
（/dev/sdc2を/optディレクトリへext3形式でマウント）
# ls /opt}
lost+found

# df}
Filesystem           1K-ブロック    使用   使用可 使用% マウント位置
/dev/sda1              4567236   3444596    886888  80% /
tmpfs                   517660         0    517660   0% /dev/shm
/dev/sdc2               553408     16840    508456   4% /opt



○実習: ハードディスクのパーティションのアンマウント


umountコマンドで/optにマンウントされているファイルシステムをアンマウントします。
先の実習でマウントした/optをアンマウントしてみましょう。
umountコマンドを実行したら、lsコマンドおよびdfコマンドでアンマウントされたことを確認してみてください。

# df}
Filesystem           1K-ブロック    使用   使用可 使用% マウント位置
/dev/sda1              4567236   3444596    886888  80% /
tmpfs                   517660         0    517660   0% /dev/shm
/dev/sdc2               553408     16840    508456   4% /opt

# umount /opt}                         マウント位置/optをアンマウント
# ls /opt}

# df} 
Filesystem           1K-ブロック    使用   使用可 使用% マウント位置
/dev/sda1              4567236   3444596    886888  80% /
tmpfs                   517660         0    517660   0% /dev/shm



## スワップ領域の作成

Linuxのカーネルと呼ばれる根幹のプログラムは、ハードディスクからプログラムやデータをメモリ領域へ読み込んで実行します。プログラムやデータを新たに読み込むための空きメモリ領域がなくなると、Linuxのカーネルは今利用していないメモリ上のプログラムやデータをスワップ領域へ一時的に退避します。スワップパーティションとはLinuxのカーネルシステムがメモリの代わりとして一時的に使うハードディスクのパーティション領域です。
ハードディスクのパーティションをスワップ領域として使うのであれば、メモリサイズに対応したパーティションを確保し、スワップファイルシステムをパーティションに作成する必要があります。

### スワップファイルシステムの作成

スワップするためのパーティション確保と、ファイルシステムの作成は、インストールするときや新しくハードディスクを増設するときに実行します。
スワップ領域(スワップのパーティション)を作るにはmkswapコマンドを使います。

書式
mkswap デバイスファイル
スワップファイルシステムを作ります。


オプション
-c
不良な部分を探して利用しない

デバイスファイル
ファイルシステムをアクセスするためのデバイスファイル


### スワップの領域作成と利用

スワップ領域は作成した後にswaponコマンドを実行すると有効化できるようになります。
書式
swapon [デバイスファイル]


オプション
-s
現在利用しているスワップ領域を表示

利用中のスワップ領域はswapoffコマンドで無効化できます。
書式
swapoff [デバイスファイル]

オプション
-v
指定したスワップを無効化
-a
すべてのスワップを無効化



○実習: スワップ領域を作成して有効化


早速以下の操作を行ない、スワップ領域を作成して利用できるようにしましょう。

//olnum[1]
 1. mkswapコマンドでスワップ領域を作ります。
 1. mkswapコマンドでIdが82(スワップ用)であるパーティションに、スワップファイルシステムを作ります。
 1. swaponコマンドに-sオプションを付けて、現在のスワップ領域の状況を表示してください。
 1. swaponコマンドでスワップ領域を有効化します。

# fdisk -l}
（ハードディスクのパーティションを表示）
ディスク /dev/sda: 6442 MB, 6442450944 バイト
ヘッド 255 , セクタ 63 , シリンダ 783
Units = シリンダ数 of 16065 * 512 = 8225280 バイト
（略）
デバイス ブート      始点        終点     ブロック  Id システム 
/dev/sda1   *           1         587     4715046   83  Linux
/dev/sda2             588         712     1004062+  82  Linux スワップ / Solaris
/dev/sda3             713         783      570307+  83  Linux

# mkswap -c /dev/sda2}
（/dev/sda2をスワップファイルに変更）
Setting up swapspace version 1, size = 1036378 kB

# swapon -s}
（利用開始しているスワップ領域を表示）
Filename                              Type        Size      Used  Priority
/dev/dm-1                             partition   2064376   0     -1

# swapon /dev/sda2}
（/dev/sda2をスワップファイルシステムとして利用する）
# swapon -s}
Filename                              Type        Size      Used  Priority
/dev/dm-1                             partition   2064376   0     -1
/dev/sda2                             partition   1012084   0     -4
（/etc/sad2が追加された）



○実習: スワップ領域を無効化


先の手順で追加したスワップ領域を無効化してみましょう。

//olnum[1]
 1. swaponコマンドに-sオプションを付けて、現在のスワップ領域の状況を表示してください。
 1. swapoffコマンドでスワップ領域を無効化します。
 1. swaponコマンドに-sオプションを付けて、スワップ領域が一つなくなっていることを確認します。

# fdisk -l}
（ハードディスクのパーティションを表示）
ディスク /dev/sda: 6442 MB, 6442450944 バイト
ヘッド 255 , セクタ 63 , シリンダ 783
Units = シリンダ数 of 16065 * 512 = 8225280 バイト
（略）
デバイス ブート      始点        終点     ブロック  Id システム 
/dev/sda1   *           1         587     4715046   83  Linux
/dev/sda2             588         712     1004062+  82  Linux スワップ / Solaris
/dev/sda3             713         783      570307+  83  Linux

# swapon -s}
Filename				                   Type		   Size	   Used  Priority
/dev/dm-1                             partition   2064376   0     -1
/dev/sda2                             partition   1012084   0     -4

# swapoff -v /dev/sda2}
（/dev/sda2のスワップファイルシステムを無効化）
/dev/sdc2 に swapoff

# swapon -s}
（有効化しているスワップ領域を表示）
Filename				                   Type		   Size	   Used  Priority
/dev/dm-1                             partition	2064376	0	   -1

/dev/sda2のスワップ領域が表示されなくなったことを確認します。

## 自動マウント

インストール時に作られたパーティションは、コンピュータの起動時に自動マウントされます。起動時に自動マウントされる設定を記述するファイルは/etc/fstabというパスにある設定ファイルです。自動マウントにはmountコマンドが使われます。増設したハードディスクを自動マウントするために、/etc/fstabファイルを変更してください。
/etc/fstabファイルに記述されるのは次の項目です。

 * ブロックスペシャルデバイス
 * マウントポイント
 * ファイルシステムのタイプ(ext3,swapなど)
 * オプション(カンマで区切る)
 * dumpコマンドがダンプ(バックアップ)するか否か(0・・・ダンプ不要,1・・・ダンプ)
 * ブート時にチェックする順番

書式
mount -a
デバイスをマウントします。


オプション
-a
/etc/fstabファイルに指定されたswap以外のパーティションをマウント



○実習: 新しく作ったパーティションの自動マウント


先の手順で手動マウントした/dev/sda3を自動で/optにマウントするように設定しましょう。
/etc/fstabに記述しておくことで、CentOSが起動時に自動的にマウントするようになります。

### 自動マウントする前に現状の構成を確認

# df}
Filesystem           1K-ブロック    使用   使用可 使用% マウント位置
/dev/sda1              4567236   3470024    861460  81% /
tmpfs                   517660         0    517660   0% /dev/shm


### fstabに自動マウントしたいパーティションを追記

# vi /etc/fstab}
/dev/sda3     /opt     ext3    defaults     1 2


### マウントの実行と確認

# mount -a}
# df}
Filesystem           1K-ブロック    使用   使用可 使用% マウント位置
/dev/sda1              4567236   3470024    861460  81% /
tmpfs                   517660         0    517660   0% /dev/shm
/dev/sda3               553408     16840    508456   4% /opt


mountコマンドに-aオプションを付けた場合、fstab に記載されているファイルシステムをすべてマウントします。

### 再起動後、自動マウントされる事を確認

# reboot}

# df}
Filesystem           1K-ブロック    使用   使用可 使用% マウント位置
/dev/sda1              4567236   3470024    861460  81% /
tmpfs                   517660         0    517660   0% /dev/shm
/dev/sda3               553408     16840    508456   4% /opt


新しいパーティションが、mountコマンドを実行しなくても自動マウントされる事を確認します。

## CD/DVD/USBメモリ(リムーバブルメディア)の利用

電源を入れたまま取り外したり装着してメディアを取り替えられるリムーバブルな外部記憶装置として、CD/DVDドライブやUSBメモリがあります。
リムーバブルメディアを使用する場合、手動でマウントをする必要があります（一部のディストリビューションでは、自動的にマウントされる場合があります）。
リムーバブルメディアのマウントポイントとして、/mntディレクトリや/mediaディレクトリの下に作られたディレクトリが使われます。

### CD/DVDのマウント

CD/DVDをLinuxで使用するには、mountコマンドでマウントを行ないます。さらにオプションとして、タイプにCDの規格であるiso9660を、モードに読み込み専用のro（Read Only）を指定します。


○実習: DVD-ROMのマウント


DVD-ROMをマウントしてアクセスしてみます。
CentOSのインストールメディアを端末のDVDドライブに挿入してから実行してください。

# mkdir /media/cdrom}
（マウントするためのディレクトリを作成） 

# mount -t iso9660 -o ro /dev/cdrom /media/cdrom}
（DVD-ROMをマウント）
# ls /media/cdrom}
（マウントポイントを確認）
CentOS_BuildTag           RPM-GPG-KEY-CentOS-6           images
EULA                      RPM-GPG-KEY-CentOS-Debug-6     isolinux
GPL                       RPM-GPG-KEY-CentOS-Security-6  repodata
Packages                  RPM-GPG-KEY-CentOS-Testing-6
RELEASE-NOTES-en-US.html  TRANS.TBL


実習例では、デバイス/dev/cdromを/media/cdromディレクトリにマウントしています。ディストリビューションによっては、/media/cdromディレクトリが存在しないので、代わりに/mntを指定します。
正常にマウントできたら、lsコマンドでDVD-ROMの中身を参照してください。

### CD/DVDのアンマウントと取り出し

マウントしたCD/DVDを取り出すには、umountコマンドでアンマウントを行ないます。


○実習: DVD-ROMのアンマウント


さきほどマウントしたDVD-ROMをアンマウントしてみましょう。

# umount /media/cdrom}
（DVD-ROMをアンマウント）
# ls /media/cdrom}
（マウントポイントを確認）


### アンマウントできない場合

マウントポイントが使用中であったり参照中の場合はアンマウントすることはできません。具体的に言うと、マウントポイント以下がカレントディレクトリである場合や、リムーバブルメディアに含まれるファイルを参照している場合などです。ディレクトリを使用していないか確認し、カレントディレクトリを移動したり、処理を終了してからアンマウントしてください。特に複数の端末ウィンドウを開いている場合は要注意です。

## iノード

ext3(ext2)ファイルシステムは、ファイルやディレクトリに対し、iノード番号というユニークな番号を割り振って管理しています。
ファイルシステムを作成した時にiノード領域という場所が確保されます。iノード領域には、ファイルがディスク上にある位置やアクセス権限などの情報が保持されています。
ファイルシステムに作れるファイル数は、iノード領域の大きさに左右されることとなります。もしファイルが多く作られてiノード領域が足りなくなると、そのファイルシステムにデータを書き込める空き領域があっても、新規のファイルが作成できなくなります。

//indepimage[linuxtext2-img15][][latex::width=0.8\maxwidth]


### iノード情報の確認

ext3ファイルシステムのiノード領域の使用状況を確認するには、dfコマンドに-iオプションを付けて実行します。iノード情報として、全体の数、使用している数、残りの数、使用量(%)が表示されます。

書式
df -i
ファイルシステムの情報を表示します。


オプション
-i
iノード情報の表示をします



○実習: iノード情報の表示


df -iコマンドを実行して、システムのiノード情報を表示してみましょう。
以下の例のようにコマンドを実行してみてください。

# df -i}
（iノード情報を表示）
Filesystem            Iノード  I使用   I残り I使用% マウント位置	
（iノードの使用情報が表示される）
/dev/sda1            1179648  150788 1028860   13% /
tmpfs                 129415       1  129414    1% /dev/shm
/dev/hdc                   0       0       0    -  /media/cdrom


表示されているデバイス/dev/sda1は、Linuxのファイルシステムであるext3ファイルシステムとなっているのでiノード情報が表示されます。一方、DVD-ROMドライブはext3ファイルシステムでない(ISO9660規格のファイルシステム)のでiノード情報を持たないことがわかります。

### iノード番号の確認

ファイルに割り振られているiノード番号を確認するには、lsコマンドに-iオプションを付けて実行します。


○実習: iノード番号の確認


ls -iコマンドを実行して、システムのiノード番号を表示してみましょう。
以下の例のようにコマンドを実行してみてください。

$ ls -il /bin | sort}
（iノード番号を表示）

（略）
750812 -rwxr-xr-x  1 root root  18568  2月 22  2005 setserial
750813 -rwxr-xr-x  1 root root  57488  5月  3  2007 cpio
750814 -rwxr-xr-x  3 root root  56080  7月 15  2007 gunzip
750814 -rwxr-xr-x  3 root root  56080  7月 15  2007 gzip
750814 -rwxr-xr-x  3 root root  56080  7月 15  2007 zcat
750815 -rwxr-xr-x  1 root root   6420 11月 26 22:52 dmesg
750816 -rwxr-xr-x  1 root root  31892 11月 18 02:55 setfont
（略）


実行例では、行頭(1番目)にiノード番号が表示され、gunzipコマンド、gzipコマンド、zcatコマンドに同じiノード番号が割り振られています。ファイル名が別々でもiノード番号が同じファイルは、ファイルとしての実体は同じなハードリンクという仕組みを表しています。3番目に表示されている項目の3という数字はリンク数で、1つのファイル実体を3つのファイル名でリンクしていることを表しています。

## ハードリンクとシンボリックリンク

リンク機能は、ファイルをコピーしたり移動したりせずに、別のディレクトリにあるように扱うことができる機能です。
たとえば、コマンドの引数としてファイルやディレクトリを指定する場合、パス指定が長くて複雑になると入力を間違えることがあるでしょう。リンク機能を使えば、よく使うファイルを自分のホームディレクトリに置いてあるように扱うことができます。
リンクには、ハードリンクとシンボリックリンクの2種類があります。

### ハードリンク

ハードリンクは、ファイルの実体を直接指し示して共有します。ハードリンクを削除しても、元ファイルは削除されません。ハードリンクはiノード番号を共有することで実現しているので、別ファイルシステム（別パーティション）には作成することができません。

### シンボリックリンク

シンボリックリンクは、元ファイルが保管されている位置（パス）を示す擬似的なファイルを作ります。シンボリックリンクを消しても元ファイルに影響はありません。元ファイルを消すとシンボリックリンクからのアクセスがエラーとなります。シンボリックリンクは別ファイルシステムの間で作成することができます。Windowsではショートカットと呼ばれるファイルと考え方が同じです。

書式
ln 元ファイル名 リンク名


オプション
-s
シンボリックリンクを作成します。
-sオプションを付けない場合はハードリンクを作成します。



○実習: ハードリンクの作成


fileコマンドのコピーを用意し、lnコマンドでfileのハードリンクであるfile2を作ります。fileファイルを削除しても、file2が実行できるので、データが削除されないことがわかります。

$ cp -p /usr/bin/file .}
$ ln file file2}
（ハードリンクを作成）
$ ls -il file*}
559793 -rwxr-xr-x 2 root root 12428  5月 31  2007 file
（コピーされたファイル）
559793 -rwxr-xr-x 2 root root 12428  5月 31  2007 file2
（ハードリンクされたファイル）

$ rm file}
（元ファイルを削除）
$ ./file2}
（ハードリンクされたファイルを実行）
Usage: file2 [-bcikLnNsvz] [-f namefile] [-F separator] [-m magicfiles] file...
       file2 -C -m magicfiles
（ハードリンクされたファイルが実行できる）
Try `file --help' for more information.

# rm file2}
（ハードリンクされたファイルを削除）


ファイルは必ずiノード情報にリンクしており、ファイルを作るとハードリンクが1つできることと同じです。ファイルのハードリンクを作るとiノードの領域にあるリンク数が1つ増え、ハードリンクを削除するとリンク数が1つ減ります。ファイルを消してリンク数が0になると、ファイルのデータがファイルシステムから完全に削除されます。


○実習: シンボリックリンクの作成


早速シンボリックリンクを作成してみましょう。ここではlessのマニュアルをファイル出力したものにシンボリックリンクを張って、シンボリックリンクを参照してみましょう。
lsコマンドで調べるとシンボリックリンクファイルはパーミッション情報の先頭がlで表示されることも確認します。

$ man less > man-less}
（man-lessというファイルのシンボリックリンクを作成するための準備）

$ ln -s man-less doc-less}
（man-lessのシンボリックリンク（doc-less）を作成）

$ ls -il *-less}
（シンボリックリンクを確認）

668311 lrwxrwxrwx. 1 tooyama tooyama     8  6月 14 11:56 2012 doc-less -> man-less
660339 -rw-rw-r--. 1 tooyama tooyama 89526  6月 14 11:55 2012 man-less

$ cat doc-less}
（man-lessと同様の内容が表示されることを確認）

（略）
      [参考訳]
       Copyright (c) 1994-2000  Kazushi (Jam) Marukawa, 日本語化ルーチンのみ。
       この部分に関するコメントは jam@pobox.com へ送って下さい。
       このパッチは Less ライセンスの下で配布できる。

                           Version 358: 08 Jul 2000                    LESS(1)


## ディスクを管理するコマンド

ハードディスクを管理するコマンドとして、ファイルシステムをチェックして修復するfsckコマンドや、ファイルやディレクトリが使っているディスク容量を調べるduコマンドがあります。

### ファイルシステムのチェックと修復

コンピュータが異常終了するなど正常にシャットダウンが行われないと、ファイルシステムのファイル管理情報とハードディスクに書き込まれたデータとの間で辻褄が合わなくなることがあります。ファイルシステムが不整合に陥った場合、fsckコマンドを使って整合性をチェックし、修復を行なう必要があります。fsckコマンドは、異常終了した後のシステム起動時に自動的に実行されます。

書式
fsck デバイス名
ファイルシステムのチェックと修復をします。


### fsckとジャーナリング機能

ジャーナリング機能を持つext3ファイルシステムは、ジャーナル情報があるので修復が素早く行えます。一方、ext2ファイルシステムはジャーナル情報がないので、全ての管理情報が正しいかチェックする必要があるので修復にとても時間がかかります。


○実習: ハードディスクのチェック


fsckコマンドでext3ファイルシステムを修復します。fsckコマンドにはハードディスクのデバイスファイルとして/dev/sdc3を指定しました。

# fsck /dev/sda3}
（/dev/sda3をチェック）
fsck from util-linux-ng 2.17.2
e2fsck 1.41.12 (17-May-2010)
opt: clean, 11/70400 files, 6426/140568 blocks
（ファイルシステムのチェック）


マウントされているハードディスクをチェックして修復できますが、修復中にファイルシステムが書き換えられると、更に問題が増えるかもしれません。修復をするときは、チェックするパーティションがアンマウントされている状態でのfsckコマンドの実行をお薦めします。

### ディレクトリ使用量の確認

dfコマンドでハードディスクなどの全体の使用量を確認できました。細かいディレクトリの使用量を調べるにはduコマンドを使います。

書式
du [ディレクトリ]
du [ファイル]
ディレクトリの使用量を調べます
ファイルのサイズを調べます


オプション
-s
指定ファイルや指定ディレクトリの総計を表示します。



○実習: ディレクトリ使用量の確認


duコマンドに-sオプションを付けると、/usrディレクトリにあるディレクトリ毎の全ファイルのサイズの総計を表示します。(/usrディレクトリにファイルがあれば、ファイルのサイズも表示されます)

# du -s /usr/*}
（/usrディレクトリにある各ディレクトリのファイルサイズの総計を表示）

24      /usr/X11R6
9184    /usr/arc
307200  /usr/bin
8       /usr/etc
8       /usr/games
158984  /usr/include
1900    /usr/kerberos
927576  /usr/lib
53228   /usr/libexec
248     /usr/local
34540   /usr/sbin
1936436 /usr/share
82480   /usr/src
4       /usr/tmp

