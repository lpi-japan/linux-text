# ネットワークの設定と管理
Linuxはサーバー用途で利用することが多いため、ネットワークに接続することが重要になります。

本章では、Linuxをネットワークに接続するために必要とされる基礎知識と確認コマンドと設定を見ていきます。

IPアドレスの確認
通信の確認
名前解決の確認
ルーティングの確認

## IPアドレスの確認
最初に、使用しているLinuxに設定されているIPアドレスの確認を行います。IPアドレスの確認は、ipコマンドを使います。

ipコマンドはネットワークに関わる様々な情報の表示が行えるコマンドで、サブコマンドの指定によって動作が変わります。サブコマンドとして「address」を指定することで、ネットワークインターフェースの情報を表示します。インターフェースを省略すると、すべてのインターフェースについて表示します。

書式
ip a[ddress] [インターフェース]


$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:fb:82:26 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s8
       valid_lft 74465sec preferred_lft 74465sec
    inet6 fd00::a00:27ff:fefb:8226/64 scope global dynamic noprefixroute
       valid_lft 85946sec preferred_lft 13946sec
    inet6 fe80::a00:27ff:fefb:8226/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:a2:d5:45 brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.3/24 brd 192.168.56.255 scope global dynamic noprefixroute enp0s9
       valid_lft 74464sec preferred_lft 74464sec
    inet6 fe80::a00:27ff:fea2:d545/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

ここでは、3つのインターフェースがあるのがわかります。

### ローカルループバックアドレス
ネットワークインターフェースloは、ローカルループバックのためのインターフェースです。ローカルループバックは自分自身と通信するための仕組みです。IPアドレスは通常127.0.0.1が割り当てられます。

### 外部通信用のIPアドレス
ネットワークインターフェースenp0s3が、NATによる外部との通信のために用意されているインターフェースです。IPアドレスとして10.0.2.15が割り当てられています。

### 内部通信用のIPアドレス
ネットワークインターフェースenp0s8が、ホストオンリーネットワークによるホストOSとの通信のために用意されているインターフェースです。IPアドレスとして192.168.56.2が割り当てられています。

## pingコマンドによるIP通信の確認
コンピューター間の通信は、IP（Internet Protocol）というプロトコルによる通信で成り立っています。

IPによる通信が行えることを確認するには、pingコマンドを使います。

書式
ping IPアドレスまたはホスト名

pingコマンドの引数にIPアドレス、またはホスト名を指定することで、指定先との間でIP通信が行えるかを確認します。

インターネットに接続できる環境であれば、インターネット上のコンピューターとの接続も確認できます。

以下の実行例では、インターネット上にあるlinuc.orgという名前のサーバーとの間でのIP通信を確認しています。

$ ping linuc.org
PING linuc.org (219.94.236.161) 56(84) bytes of data.
64 バイト応答 送信元 219.94.236.161: icmp_seq=1 ttl=255 時間=16.3ミリ秒
64 バイト応答 送信元 219.94.236.161: icmp_seq=2 ttl=255 時間=15.7ミリ秒
^C
--- linuc.org ping 統計 ---
送信パケット数 2, 受信パケット数 2, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 15.668/15.991/16.315/0.323 ms

pingコマンドは、停止しない限り繰り返し通信ができるかの確認を行い続けます。Ctrl+cを入力して、停止してください。

pingコマンドの結果には、通信が往復するのにどれぐらい時間がかかったのかも表示されます。海外などネットワーク的に距離があるコンピューターとの通信には時間がかかりますが、距離が近いコンピューターとの通信に時間がかかる場合には、ネットワークが混雑しているか、あるいはネットワーク障害などが起きている可能性があります。

//indepimage[linuxtext2-img09][][latex::width=0.8\maxwidth]

### pingコマンドに反応しない場合
pingコマンドの通信はTCPやUDPではなく、ICMPのEchoという仕組みを使っていますが、相手のコンピューターがEchoに反応しない場合があります。これはセキュリティの関係上、ICMP Echoに反応して存在を知られないようにするためです。pingコマンドに反応しないからといって、IPによる通信が行えないわけではないことに注意が必要です。

## 名前解決の確認
名前解決とは、ホスト名をIPアドレスに変換する仕組みのことです。Webサーバーやメールサーバーでやり取りをするには必須となる技術です。

すべてのインターネットの通信をIPアドレスを直に指定して行うのは不便です。そこで、外部からのアクセスを受け付けたい組織はドメイン名を取得し、インターネットに接続するコンピューターにドメイン名（正確にはホスト名）を割り当てます。割り当てたホスト名とIPアドレスの組み合わせは、名前解決で調べられるようにしておきます。利用者は名前解決を行って、ホスト名からIPアドレスを取得して通信を行います。

名前解決の仕組みは様々なものがありますが、最もよく使われているのがDNS（Domain Name System）です。DNSを使って、名前解決ができるかどうかを確認するには、digコマンドを使います。

書式
dig ホスト名

以下の実行例では、digコマンドを使ってlinuc.orgを名前解決しています。

$ dig www.linuc.org

; <<>> DiG 9.16.23-RH <<>> www.linuc.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37099
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.linuc.org.			IN	A

;; ANSWER SECTION:
www.linuc.org.		3588	IN	A	219.94.236.161

;; Query time: 20 msec
;; SERVER: 10.0.2.3#53(10.0.2.3)
;; WHEN: Mon Sep 16 14:14:49 JST 2024
;; MSG SIZE  rcvd: 58


名前解決が行われて、ANSWER SECTIONにIPアドレスが表示されているのがわかります。

### 参照しているDNSの確認
DNSは、名前解決を行ってくれるDNSサーバーが動作しており、そのDNSサーバーに対して名前解決のリクエストを送ることでIPアドレスがわかります。参照しているDNSを間違えていると、名前解決が行えなくなります。

参照しているDNSは、/etc/resolv.confに記述されています。

$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 10.0.2.3
nameserver fd00::3

この設定では、IPアドレス10.0.2.3をDNSサーバーとして参照しているのがわかります。この設定ファイルを直接修正して動作を変更することもできますが、1行目に書かれている通り、この設定ファイルはNetworkManagerという仕組みでシステム起動時に自動的に生成されています。設定変更は後述するNetworkManagerの設定変更方法に従って行ってください。

## ルーティングの確認
コンピューターがネットワークで通信するためにはLAN（Local Area Network）に接続します。同じLANに接続されているコンピューター同士は直接通信を行えます。一方、その他のLANに接続されているコンピューターやインターネット上に接続されているコンピューターと通信を行うには、ルーターを通じて通信を行う必要があります。ルーターを介して外部ネットワークと通信を行うことを「ルーティング」と呼びます。

ルーティングを行うためのデフォルトのルーターのことを「デフォルトゲートウェイ」と呼びます。

コンピューターに設定されているルーティングを確認するには、ip routeコマンドを実行します。

$ ip route
default via 10.0.2.2 dev enp0s3 proto dhcp src 10.0.2.15 metric 100
10.0.2.0/24 dev enp0s3 proto kernel scope link src 10.0.2.15 metric 100
192.168.56.0/24 dev enp0s8 proto kernel scope link src 192.168.56.3 metric 101

1行目は、デフォルトゲートウェイが10.0.2.2に設定されており、通信にはネットワークインターフェースenp0s3を使用することを表しています。
2行目は、このコンピューターがNATで接続されているネットワーク（10.0.2.0/24）と通信するには、ネットワークインターフェースenp0s3を使用すると設定されていることを表しています。
3行目は、このコンピューターがホストオンリーネットワークで接続されているネットワーク（192.168.56.0/24）と通信するには、ネットワークインターフェースenp0s8を使用すると設定されていることを表しています。

外部との通信が行えない場合には、まずコンピューター自身のルーティングを確認するようにしてください。


