# ネットワークの設定と管理
Linuxをネットワークに接続するために必要とされる基礎知識と確認コマンドと設定を見ていきます。

IPアドレスの確認
通信の確認
名前解決の確認
ルーティングの確認

### IPアドレスを確認
IPアドレスの確認は、ipコマンドを使います。ipコマンドはネットワークに関わる様々な情報の表示が行えるコマンドで、サブコマンドの指定によって動作が変わります。サブコマンドとして「address」を指定することで、ネットワークインターフェースの情報を表示します。インターフェースを省略すると、すべてのインターフェースについて表示します。

書式
ip a[ddress] [インターフェース]


$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens160: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:0c:29:41:35:c7 brd ff:ff:ff:ff:ff:ff
    altname enp2s0
    inet 192.168.156.136/24 brd 192.168.156.255 scope global dynamic noprefixroute ens160
       valid_lft 1073sec preferred_lft 1073sec
    inet6 fe80::20c:29ff:fe41:35c7/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

ネットワークインターフェースloは、ローカルループバックのためのインターフェースです。ローカルループバックは自分自身と通信するための仕組みで、IPアドレスは通常127.0.0.1が割り振られます。

ネットワークインターフェースens160が、外部との通信のために用意されているインターフェースです。IPアドレスとして192.168.156.136が割り当てられているのがわかります。

### pingコマンドによるIP通信の確認
IPによる通信が行えることを確認するには、pingコマンドを使います。pingコマンドの引数にIPアドレス、またはホスト名を指定することで、指定先との間でIP通信が行えるかを確認します。pingコマンドはTCPではなく、ICMP（Internet Control Message Protocol）というプロトコルを使って通信を行います。

書式
ping IPアドレスまたはホスト名

インターネットに接続できる環境であれば、インターネット上のコンピューターとの接続も確認できます。

$ ping linuc.org
PING linuc.org (219.94.236.161) 56(84) bytes of data.
64 バイト応答 送信元 219.94.236.161: icmp_seq=1 ttl=128 時間=18.0ミリ秒
64 バイト応答 送信元 161.236.94.219: icmp_seq=2 ttl=128 時間=16.7ミリ秒
^C
--- linuc.org ping 統計 ---
送信パケット数 2, 受信パケット数 2, 0% packet loss, time 1000ms
rtt min/avg/max/mdev = 16.650/17.300/17.950/0.650 ms


pingコマンドは、停止しない限り繰り返し通信ができるかの確認を行い続けます。Ctrl+cを入力して、停止してください。

pingコマンドの結果には、通信が往復するのにどれぐらい時間がかかったのかも表示されます。海外などネットワーク的に距離があるコンピューターとの通信には時間がかかりますが、距離が近いコンピューターとの通信に時間がかかる場合には、ネットワークが混雑しているか、あるいはネットワーク障害などが起きている可能性があります。

//indepimage[linuxtext2-img09][][latex::width=0.8\maxwidth]

### pingコマンドに反応しない場合
pingコマンドはICMPのEchoという仕組みを使っていますが、相手のコンピューターがEchoに反応しない場合があります。これはセキュリティの関係上、ICMP Echoに反応して存在を知られることが無いようにするためです。pingコマンドに反応しないからといって、通信が行えていないわけではないことに注意が必要です。

### 名前解決の確認
名前解決とは、ホスト名をIPアドレスに変換する仕組みのことです。すべてのインターネットの通信を直にIPアドレスを指定して行うのは不便なので、インターネットに接続する各組織にドメイン名を割り当てて、その組織がインターネットに接続している、すなわちIPアドレスを持っているコンピューターにホスト名を割り当てるようになっています。他のコンピューターからの通信を受け付けたいコンピューターは、名前解決でホスト名からIPアドレスが割り出せるようにしておきます。

名前解決の仕組みは様々なものがありますが、最もよく使われているのがDNS（Domain Name System）です。DNSを使って、名前解決ができるかどうかを確認するには、digコマンドを使います。

書式
dig ホスト名

digコマンドを使って、linuc.orgを名前解決してみます。

$ dig www.linuc.org

; <<>> DiG 9.16.23-RH <<>> www.linuc.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 35272
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; MBZ: 0x0005, udp: 4096
;; QUESTION SECTION:
;www.linuc.org.			IN	A

;; ANSWER SECTION:
www.linuc.org.		5	IN	A	219.94.236.161

;; Query time: 0 msec
;; SERVER: 192.168.156.2#53(192.168.156.2)
;; WHEN: Sat Aug 17 09:20:47 JST 2024
;; MSG SIZE  rcvd: 58

ANSWER SECTIONにIPアドレスが名前解決されて表示されているのがわかります。

### 参照しているDNSの確認
DNSは、名前解決を行ってくれるDNSサーバーが動作しており、そのDNSサーバーに対して名前解決のリクエストを送ることでIPアドレスがわかります。参照しているDNSを間違えていると、名前解決が行えなくなります。

参照しているDNSは、/etc/resolv.confに記述されています。

$ cat /etc/resolv.conf
# Generated by NetworkManager
search localdomain
nameserver 192.168.156.2

この設定では、IPアドレス192.168.156.2をDNSサーバーとして参照しているのがわかります。この設定ファイルを直接修正して動作を変更することもできますが、1行目に書かれている通り、この設定ファイルはNetworkManagerという仕組みでシステム起動時に自動的に生成されています。設定変更は後述するNetworkManagerの設定変更方法に従って行ってください。

## ルーティングの確認
コンピューターはLANに接続されていますが、その他のLANに接続されているコンピューターやインターネット上に接続されているコンピューターと通信を行うには、ルーターを通じて通信を行う必要があります。ルーターを介して外部ネットワークと通信を行うことを「ルーティング」と呼びます。

ルーティングを行うためのデフォルトのルーターのことを「デフォルトゲートウェイ」と呼びます。

コンピューターに設定されているルーティングを確認するには、ip routeコマンドを実行します。

$ ip route
default via 192.168.156.2 dev ens160 proto dhcp src 192.168.156.136 metric 100
192.168.156.0/24 dev ens160 proto kernel scope link src 192.168.156.136 metric 100

2行目は、このコンピューターが接続されているネットワーク（192.168.156.0/24）と通信するには、ネットワークインターフェースens160を使用すると設定されていることを表しています。
1行目は、デフォルトゲートウェイが192.168.156.2に設定されていることを表しています。

### 外部のコンピューターとの通信経路を調べる
デフォルトゲートウェイは、コンピューターが接続されているLANからの出入り口となっています。外部のコンピューターとの通信は、様々なネットワークとルーターを経由して行われています。

どのような経路を通じて通信を行っているか調べるには、tracepathコマンドを使います。

//indepimage[linuxtext2-img12][][latex::width=0.8\maxwidth]

書式
tracepath IPアドレス

linuc.orgのIPアドレスに対する通信経路を調べてみます。

$ tracepath 210.173.176.63
 1?: [LOCALHOST]                      pmtu 1500
 1:  _gateway                                              0.773ミリ秒
 1:  _gateway                                              0.634ミリ秒
 2:  WRC-2533GS2                                           1.871ミリ秒 asymm  1
 3:  ike-bbrt10.transix.jp                                10.807ミリ秒 asymm  1
 4:  210.173.176.63                                       11.500ミリ秒 到達しました
     Resume: pmtu 1500 hops 4 back 1

いくつかのルーターを経由して、指定したIPアドレスに到達しているのがわかります。


