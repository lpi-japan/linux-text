# Linuxのインストールと設定
第3章では、VirtualBoxで作成した仮想マシンにAlmaLinuxをインストールします。インストール後、初期設定とネットワーク接続の確認を行います。

## 利用するLinuxのディストリビューション
本教科書では、AlmaLinux 9.4のIntel/AMD x86_64アーキテクチャに対応したバージョンを利用します。

```
https://almalinux.org/ja/
```

![AlmaLinuxのWebサイト](image/Ch1/AlmaLinuxOrg.png){width=70%}

AlmaLinuxは、商用ディストリビューションであるRed Hat Enterprise Linuxをベースにしたディストリビューションとして提供されています。利用に際し費用が発生しない、無償で提供されているディストリビューションです。

### インストール用ISOイメージの入手
AlmaLinuxが配布しているISOイメージを、ダウンロードします。仮想マシンは、ISOイメージを仮想光学ドライブにセットすることでインストールが行えるので、インストール用のDVD/USBメモリを作成する必要がありません。

#### ダウンロード方法
ISOイメージをダウンロードするには、以下のURLにアクセスします。

```
https://mirrors.almalinux.org/isos/x86_64/9.4.html
```

このURLにアクセスすると、多くのミラーサイトが表示されます。例えば、IIJが提供しているミラーサイトのURLであれば次のようになります。

```
http://ftp.iij.ad.jp/pub/linux/almalinux/9.4/isos/x86_64
```

#### URLが利用できない場合
URLはサイト構造の変更によって変わっている場合があります。その場合には、AlmaLinuxのWebサイトからリンクを辿ってダウンロードサイトを探してください。

![AlmaLinuxのダウンロードサイト](image/Ch1/AlmaLinuxDownload.png){width=70%}

## ISOイメージのファイル名
ISOイメージは以下のようなファイル名になっています。

AlmaLinux-バージョン-アーキテクチャ-イメージの種類.iso

## バージョン
本教科書では、本教科書の作成時点で最新であったAlmaLinux 9.4を利用して解説しています。

今後のバージョンアップで、より新しいバージョンのAlmaLinuxが入手可能になっているかもしれません。バージョン9系であればマイナーバージョンによる大きな差は無いと推測されますが、セキュリティ対応などの関係で動作が変わる場合があります。

初めて本教科書の内容を学習する際には、まずはバージョンを合わせて動作を確認し、その後異なるバージョンで同様に動作するか確認してみてください。バージョンによる動作の違いについては、本教科書の情報交換を行うSlackで情報共有を行い、本教科書の今後のバージョンアップで対応していく予定です。

## アーキテクチャ
Linuxカーネルは様々な種類のCPUアーキテクチャに対応しています。アーキテクチャによってバイナリが異なるため、アーキテクチャに合わせたISOイメージを選択する必要があります。主なアーキテクチャには以下のものがあります。

### x86_64
IntelやAMDのCPUアーキテクチャです。64ビット版になります。

### aarch64
ARMのCPUアーキテクチャです。64ビット版になります。ARMを搭載したWindowsや、Apple Siliconを搭載したMacを使う場合にはこちらをダウンロードします。

## ISOイメージの種類
ISOイメージには、いくつかの種類があります。インストールの目的によってイメージを選択します。AlmaLinuxには以下の3種類のISOイメージが用意されています。

- 起動のみ（boot.iso）
- 最低限（minimal.iso）
- フルパッケージ（dvd.iso）

本教科書の演習では、GUI環境も使用するため、フルインストールが可能なISOイメージ（dvd.iso）を使ってインストールします。AlmaLinux-9.4-x86_64-dvd.isoをダウンロードしてください。

## ISOイメージを仮想光学ドライブで読み込む設定
ダウンロードしたOSインストール用のISOイメージを、仮想マシンの仮想光学ドライブで読み込む設定をします。

VirtualBoxマネージャーから仮想マシンを選択し、右側の各種設定情報から「ストレージ」を選択します。

仮想マシンには、IDEとSATAの2種類のストレージデバイスが接続されています。仮想光学ドライブはIDEに接続されています。読み込む設定が何もされていない場合、「空」と表示されているのが仮想光学ドライブですので、選択します。

「光学ドライブ:IDE セカンダリデバイス0」の右側にある円形のボタンをクリックし、「Choose a Disk File...」を選択すると、ファイルダイアログが開きます。準備しておいたOSインストール用のISOイメージを選択し、「開く」ボタンをクリックします。「空」の表示がファイル名に変わります。

![仮想マシンの仮想光学ドライブの設定画面](image/Ch2/VMconfigDVD.png){width=70%}

## 仮想マシンの起動
VirtualBoxマネージャーで仮想マシンを選択し、「起動」をクリックします。別ウインドウで仮想マシンが起動します。

### ISOイメージファイルのマウント
あらかじめ仮想マシンの仮想光学ドライブにISOイメージを読み込ませる設定をしていない場合、起動用のISOイメージを設定するダイアログが表示されます。

画面の指示に従って、ISOイメージのファイルを指定し、「マウントとブートのリトライ」ボタンをクリックして起動します。

![マウントとブートのリトライダイアログ画面](image/Ch3/BootDialog.png){width=70%}

## OSのインストール
以下の手順に従って、OSのインストールを行います。

### インストーラ起動オプションの選択
OSインストール用のISOイメージを読み込んで起動すると、最初にGRUBというブートローダーが起動します。ここでインストーラの起動オプションを選択できます。

デフォルトの「Test this media & Install AlmaLinux 9.4」で起動し、ISOイメージが壊れていないかテストを行った上でインストールを行います。すでに選択されているので、Enterキーを押します。

![GRUB画面](image/Ch3/GRUB.png){width=70%}

### 言語選択
言語の選択画面が表示されるので、左側のメニューから「日本語 Japanese」を選択します。画面右側のメニューに「日本語（日本）」が表示されます。

「続行」ボタンをクリックします。

![言語選択画面](image/Ch3/selectLang.png){width=70%}

### インストール概要
インストール概要の画面では、各種設定がまとめて表示されます。

「!」が付いた項目は、必ず設定が必要な項目です。

![インストール概要画面](image/Ch3/installOverView.png){width=70%}

### インストール先の設定
「インストール先」をクリックします。画面が切り替わり、「デバイスの選択」や「ストレージの設定」が行えます。

デフォルトで、仮想マシン作成時に新規作成した仮想ハードディスクがローカル標準ディスクとして選択されています。また、そのデバイスのパーティション設定は自動構成が選択されています。

今回はデフォルトのままインストール先を設定するので、そのまま「完了」ボタンをクリックします。

![インストール先の設定画面](image/Ch3/installDisk.png){width=70%}

### ソフトウェアの追加インストール
「ソフトウェアの選択(S)」をクリックします。画面が切り替わり、大まかな用途を決める「ベース環境」と、追加でインストールするソフトウェアが選択できます。実習で利用するソフトウェアをあらかじめインストールしておきます。

ベース環境は「サーバー（GUI使用）」を選択します。右側の「選択した環境用のその他のソフトウェア」リストから、インストールしたいソフトウェアとして「ベーシックWebサーバー」をチェックして追加でインストールします。

![ソフトウェアの追加選択画面](image/Ch3/selectSoftwareCustom.png){width=70%}

### ユーザーの作成
「ユーザーの作成(U)」をクリックします。実習で使用するユーザーを作成います。

| 項目 | 設定値
| - | -
| フルネーム | LinuC
| ユーザー名 | linuc
| このユーザーを管理者にする | チェックする
| このアカウントを使用する場合にはパスワードを要求する | チェックする
| パスワード | 任意のパスワードを設定
| パスワードの確認 | 設定したパスワードを再入力

パスワードは、入力間違えが無いように「パスワード(P)」と「パスワードの確認(C)」に同じパスワードを2回入力します。長さや大文字小文字数字を混ぜるなど一定の要件を満たさないと脆弱なパスワードと判定されます。良好以上になるパスワードを入力するか、脆弱と判定された場合には「完了(D)」ボタンを2回クリックする必要があります。

ユーザーの作成の設定が完了したら、「完了(D)」ボタンをクリックします。

![ユーザーの作成の設定画面](image/Ch3/setRootPassword.png){width=70%}

\pagebreak
### インストールの開始
必要な設定が終わったら、インストールを開始します。「インストールの開始(B)」ボタンをクリックします。

![インストール開始前の画面](image/Ch3/startInstall.png){width=70%}

インストールが始まり、「インストール状況の表示」画面が表示されます。

インストールが終了したら、「システムの再起動」ボタンをクリックして、再起動します。

![インストール終了の画面](image/Ch3/finishInstall.png){width=70%}

## GUIによるログインとログアウト
Linuxを使い始めるにはログインを、使い終わったらログアウトを行います。

システムが起動したら、ログインとログアウトを試してみましょう。

### GUIでログインする
ログインするには、ログインしたいユーザーをクリックして選択し、パスワードを入力します。

![ログインの画面](image/Ch3/Login.png){width=70%}

初回ログイン時には「AlmaLinuxへようこそ」と表示され、操作方法を確認するツアーを開始できます。ツアーを見たい場合には「ツアーをチェックする」ボタンをクリックします。はじめてAlmaLinuxのGUIを操作するのであれば、短いツアーですのでチェックしてみてください。

![AlmaLinuxへようこその画面](image/Ch3/WelcomeAlmaLinux.png){width=70%}

\pagebreak

### GUIでログアウトする方法
ログアウトするには、画面右上にあるメニューバーの電源アイコンをクリックし、「電源オフ/ログアウト」をクリックすると表示される「ログアウト」をクリックします。

ログアウトを確認するダイアログが表示されるので、「ログアウト」をクリックします。

![ログアウト選択の画面](image/Ch3/Logout.png){width=70%}

## コマンド実行のための端末を起動
コマンドを実行してLinuxを操作するために「端末」アプリを起動します。

再度ログインを行い、画面左上の「アクティビティ」をクリックし、画面下に表示されるアイコンから「端末」アプリのアイコンをクリックします。

![端末起動の画面](image/Ch3/Terminal.png){width=70%}

### IPアドレスを調べる
ipコマンドを実行して、IPアドレスを調べてみます。

「端末」アプリのウインドウ内にコマンドプロンプトが表示されているので、コマンドを入力し、Enterキーを押して実行します。「ip a」コマンドは、実行したマシンに割り当てられているIPアドレスなどの情報を表示します。

$ ip a

実行した仮想マシンには、ネットワークアダプターを2つ設定しています。

「10.0.2.15」はNATに設定したアダプターのIPアドレスです。外部に接続するために使用されます。

「192.168.56.x」はホストオンリーネットワークに設定したアダプターのIPアドレスです。DHCPで動的に割り当てられるため、第4オクテットは変わる場合があります。

本教科書の実習ではネットワークを使用しないので、適切に設定されていなくても支障はありませんが、正しくIPアドレスが設定されていない場合には、第9章を参考に設定を見直してみてください。

## Webサーバーを動かしてみる
Linuxでは、コマンドを実行して各種サービスの起動や停止を行います。ここでは、OSインストール時に追加で導入したWebサーバーを起動して、Webブラウザからアクセスしてみます。

### Webサーバーを起動する
Webサーバーを起動します。Webサーバーは、Linuxではhtttpdサービスと呼ばれています。サービスの起動や停止はsystemctlコマンドを実行して行います。

Webサーバーのようなサービスは、実行するためにはLinuxのシステム管理者のユーザー権限が必要になります。ユーザーについては第7章で解説します。

「端末」アプリのコマンドプロンプトで、systemctlコマンドを実行します。

systemctl start httpd

systemctlコマンドを実行すると、システム管理者のユーザー権限があることを確認するためにユーザーlinucのパスワードを要求するダイアログが表示されるので、パスワードを入力します。OSインストール時の「ユーザーの作成」でユーザーlinucを作成する際に「このユーザーを管理者にする」をチェックしているので、ユーザーlinucのパスワードを入力することでシステム管理者のユーザー権限があることを確認できます。


★スクショ

### Webサーバー起動の確認とコマンド履歴
認証に成功すると、httpdサービスが起動します。実行結果が何も表示されていないので、起動されたことを確認するため、systemctl statusコマンドを実行します。

コマンドプロンプトには、コマンド履歴という機能があります。以前に実行したコマンドを呼び出してそのまま実行したり、修正して実行したりできます。カーソルキーの上下でコマンド履歴を呼び出し、修正する場合にはカーソルキーの左右でカーソルを動かし、DeleteキーやBackSpaceキーで文字を消すことができます。

カーソルキーの上を押して「systemctl start httpd」コマンドを呼び出し、「start」を消して「status」に書き換えて実行します。

$ systemctl start httpd
↓
$ systemctl sta httpd ※カーソルを左に移動してrtを削除
↓
$ systemctl status httpd ※tusを追加して実行

実行結果の「Active:」の項目が「active (running)」になっていれば、httpdサービスが実行中であることがわかります。サービスはいくつかのプロセスとしてバックグラウンドで実行されています。プロセスについては第10章で解説します。確認を終えたら「q」（Quit）キーを入力して表示を終了します。

### WebブラウザでWebサーバーにアクセスする
Webブラウザを起動して、Webサーバーにアクセスしてみます。

画面左上の「アクティビティ」をクリックし、画面下に表示されるアイコンから一番左にある「Firefox」アプリのアイコンをクリックします。

Webブラウザのウインドウが表示されたら、アドレスに「localhost」と入力して、Enterキーを押します。「AlmaLinux Test Page」が表示されたら、Webサーバーにアクセスできたことが確認できます。

### Webサーバーを停止してみる
Webサーバーを停止してみます。

画面左上の「アクティビティ」をクリックし、画面に表示されるウインドウから「端末」アプリのウインドウをクリックします。

コマンドプロンプトで、systemctl stopコマンドを実行します。コマンド履歴を使って実行してみてください。

$ systemctl stop httpd

再度、ユーザーlinucのパスワード認証が要求されるので、パスワードを入力します。再度systemctl statusコマンドで確認すると、「Active:」の項目が「inactive (dead)」になっています。Webブラウザで再読み込みを行うと「正常に接続できませんでした」と表示されます。

再度、systemctl startコマンドで起動し直して、正常な状態に戻るのも確認してみてください。

このように、Linuxの操作は様々なコマンドを実行して操作を行います。

## SSHでリモートログインする
Linuxが動作しているマシンが手元にある場合にはGUIで直接ログインできますが、多くの場合Linuxが動作するマシンはデータセンターやマシンルームの中に設置されていたり、クラウド上で動作しています。このようにリモートにあるLinuxを操作するには、SSHでリモートログインする必要があります。

本教科書の実習は基本的にGUIで直接ログインし、「端末」アプリのコマンドプロンプトで進めることができますが、リモート操作に慣れるために

### WindowsからSSHを行う方法
Windowsから仮想マシン上で動作するLinuxにSSHでリモートログインするには、Windows側でSSHクライアントを実行する必要があります。方法としては、以下の2つの方法があります。

- WindowsでコマンドプロンプトやPowerShellを実行し、sshコマンドを実行する
- Tera TermなどのSSHプロトコルをサポートしたソフトウェアを導入する

今回はWindowsの標準機能であるsshコマンドを使ってみます。

### Windowsのコマンドプロンプトを実行する
Windowsのコマンドプロンプトを実行します。

タスクバーの検索ウインドウに「cmd」と入力し、候補として出てきたコマンドプロンプトを実行します。

タスクバーに検索ウインドウが無い場合には、タスクバーを右クリックして「タスクバーの設定」から、検索ウインドウを表示するように設定してください。

### IPアドレスを確認する
前述のIPコマンドを使って、IPアドレスを確認します。ホストOSとゲストOSを接続するにはホストオンリーネットワークを経由する必要があります。IPアドレスはデフォルトで「192.168.56.x」になります。

$ ip a
（略）
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:a2:d5:45 brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.2/24 brd 192.168.56.255 scope global dynamic noprefixroute enp0s9
（略）

### sshコマンドでゲストOSに接続する
コマンドプロンプトでsshコマンドを実行して、ゲストOSのLinuxに接続します。

書式
ssh ユーザー名@接続先IPアドレス

以下の例では、ユーザーlinucで192.168.56.2に接続しようとしています。

>ssh linuc@192.168.56.2
The authenticity of host '192.168.56.2 (192.168.56.2)' can't be established.
ED25519 key fingerprint is SHA256:xW65Q1rynI7tb8LmiZrmu1X1O0sc8Zf/csbfsAx8Hfs.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes ※yesと入力
Warning: Permanently added '192.168.56.2' (ED25519) to the list of known hosts.
linuc@192.168.56.2's password: ※ユーザーlinucのパスワードを入力（非表示）
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Sun Sep 15 09:49:18 2024
[linuc@vbox ~]$

初めてSSHで接続する場合、接続先のホスト証明書が送られてきます。接続を続ける場合には「yes」と入力します。その後、ユーザーlinucのパスワードが要求されるので、パスワードを入力すると接続が完了します。

コマンドプロンプトが表示されれば、GUIの「端末」アプリで実行するのと同じようにコマンドを実行できます。ただし、GUIがないのでsystemctlコマンドの認証がダイアログではなくなるなどの違いがあります。

$ systemctl start httpd
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ====
'httpd.service'を開始するには認証が必要です。
Authenticating as: LinuC (linuc)
Password:
==== AUTHENTICATION COMPLETE ====

\pagebreak
