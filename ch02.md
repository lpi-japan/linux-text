# レビューを行わないでください
この章はサーバー構築標準教科書の内容をコピーしてきただけなので、現時点ではレビューを行わないでください。

# VirtualBoxのインストールと仮想マシンの作成
第2章では、実習環境の準備としてVirtualBoxをインストールして仮想マシンを作成します。

## 用語集
### 仮想化技術 {.unlisted .unnumbered}
ハードウェアの機能をソフトウェアで実現する技術。仮想マシンや仮想ネットワーク、仮想ストレージなど様々な種類の技術が存在しています。

### 仮想マシン {.unlisted .unnumbered}
仮想化技術を利用して、コンピュータのハードウェアをソフトウェアで実現したもの。OSをインストールし、様々なアプリケーションを実行できます。

### 仮想ホスト {.unlisted .unnumbered}
仮想マシンを実行するマシンのこと。仮想ホストでは通常のOSが動作しており、仮想マシンは通常のアプリケーションのように動作します。

### ゲストOS {.unlisted .unnumbered}
仮想マシンにインストールするOSのこと。仮想ホストで動作しているOSとは異なる種類のOSをインストールして実行できます。

## 仮想化環境とは
仮想化環境とは、仮想化技術を活用して構築、動作させるシステムの環境のことです。仮想化技術には、仮想マシン、仮想ネットワーク、仮想ストレージ、コンテナなどがあります。

### 仮想化技術とクラウドの関係
現在では、クラウドを活用してシステムを構築、運用することが増えています。多くのクラウドサービスが仮想化技術を活用する事で、効率良くシステムリソースをユーザーに対して提供することでそのサービスを実現しています。クラウドを理解し、活用するためにも、仮想化技術の基礎を理解しておく必要があります。

## 仮想マシンとは
仮想マシンは、ソフトウェアで仮想的なマシンを実行する仕組みです。仮想マシンにはゲストOSをインストールし、アプリケーションを実行できます。

### ホストOS型とハイパーバイザー型
仮想マシンの実行環境には、ホストOS上でアプリケーションのように実行される「ホストOS型」と、仮想マシン実行専用のソフトウェアであるハイパーバイザーが動作する「ハイパーバイザー型」に大別されます。

本教科書では、簡単に実行できるホストOS型を取り上げています。

## 仮想マシンのメリット
仮想マシンの利用には、いくつかのメリットがあります。

### ホストOSと共存できる
仮想マシンはホストOS上でアプリケーションのように実行されます。そして同時にその他のアプリケーションも実行できるので、たとえばWebブラウザで何かを調べながら、ターミナルで仮想マシン上のLinuxにログインして操作する、ということが簡単に行えます。

### ハードウェアを用意する必要がない
Linuxを使ったサーバー構築を学習する際に大きな障害となるのが学習用ハードウェア環境の準備です。ハードウェアを用意できたとしても、Linuxをインストールするには設定を変更するなどのハードウェアの知識が要求されます。メーカーの違いによって設定方法も異なるため、学習の助けを得るのも難しくなります。

仮想マシンではそのような前提知識が要求されることが少ないので、容易にLinuxをインストールして学習環境を構築できます。

### 柔軟性
仮想マシンは必要に応じて簡単にCPU数やメモリ容量、ディスク容量などを変更できる柔軟性を備えています。

### OS選択
仮想マシンにはそれぞれ別々のOSをインストールできます。たとえばLinuxとWindowsがそれぞれインストールされた仮想マシンを同時並行で実行できます。

## 仮想マシンのデメリット
仮想マシンの利用には、メリットだけでなくデメリットもあります。

### 速度
仮想マシンは、コンピュータの動作をソフトウェアで実現しているので、ハードウェアそのものでOSやアプリケーションを動作させるよりも動作が遅くなります。

### リソースの消費
仮想マシンを複数同時に実行することができますが、その分だけCPUやメモリ、ストレージなどのリソースを消費します。ホストOSを快適に動かすのにもリソースが必要となるため、使用するハードウェアにはより多くのリソースを用意する必要があります。

## 仮想マシンのリソース
仮想マシンを作成する際に、CPUやメモリ、ネットワークインターフェースなどのリソースを利用者自らが調整する必要があります。物理マシンを利用する場合にも同様の作業が必要ですが、仮想マシンの場合、ある程度後から変更できるメリットがあります。まずはデフォルト設定のまま動かしてみて、後から必要に応じて変更しても構いません。

### CPU
仮想マシンには必要なだけの数のCPUを割り当てられます。ただし、CPUをホストOSやその他の仮想マシンとの間で取り合うことになるため、沢山割り当てればよいというわけではありません。

### メモリ
仮想マシンに設定したメモリ容量は、その分だけホストマシンから仮想マシンに対して割り当てられます。ホストマシンにはホストOSだけでなく、仮想マシンに割り当てられるだけの容量のメモリを搭載しておく必要があります。

### ディスク
HDDやSSDにあたる仮想ディスクは、仮想ディスクファイルという形でホストOS上に作成されます。可変式ファイルの場合には、仮想マシンが使用した分だけのサイズのファイルになります。固定式ファイルの場合には、作成時に設定しただけの容量のファイルが作成されます。可変式にすることで、ホストマシンのディスク使用を節約できます。

### 光学ドライブ
仮想マシンに割り当てられた仮想光学ドライブは、物理的な光学ドライブにセットされたCD/DVDメディアを割り当てる他、ISOイメージを割り当てることができます。仮想マシンにOSをインストールするのが容易な理由の一つです。

### ネットワーク
仮想マシンに割り当てられるネットワークインターフェースを割り当てることができます。仮想マシンソフトウェアによって機能が異なるため、それぞれの機能に応じた利用が必要になります。

## VirtualBoxのインストール
本教科書の実習では、仮想マシンソフトウェアである「VirtualBox」上にLinuxを導入して、その環境上に様々なサーバーを導入し実際に動作させます。

### 使用するコンピュータの仮想化支援技術の有効化
VirtualBoxを実行するには、使用するコンピュータが搭載しているプロセッサの仮想化支援技術が有効になっている必要があります。仮想化支援技術は、IntelのCPUではIntel VT、AMDのCPUではAMD-Vと呼ばれます。

仮想化支援技術を有効にするには、コンピュータのUEFI設定画面で設定を行います。設定方法の詳細は、使用するコンピュータの説明書などを確認してください。

### VirtualBoxのダウンロード
VirutalBoxは、次のURLからダウンロードできます。

```
https://www.virtualbox.org/
```

![VirtualBoxのWebサイト](image/Ch2/VirtualBoxOrgMain.png){width=70%}

\pagebreak
ホストOSの種類に合わせてダウンロードを行えます。今回はWindows環境にインストールします。左のメニューからDownloadsをクリックし、VirtualBox binariesからWindows hostsをクリックして、インストーラをダウンロードします。

![VirtualBoxのダウンロードサイト](image/Ch2/VirtualBoxOrgDownload.png){width=70%}

今回はバージョン7.0.12を使用しています。これ以降のバージョンでネットワーク機能（ホストオンリーアダプター）が変更になっている可能性があるため、新しいバージョンになっている場合には過去のビルド（VirtualBox older builds）からバージョン7.0.12をダウンロードしてください。

```
https://www.virtualbox.org/wiki/Download_Old_Builds_7_0
```

\pagebreak
### VirtualBoxのインストーラの実行
VirtualBoxのインストーラをダウンロードが完了したら、インストーラを実行してインストールします。

![VirtualBoxのインストーラ画面](image/Ch2/VirtualBoxInstaller.png){width=70%}

インストール時の特別な設定は行いませんので、インストーラの指示に従ってインストールします。インストーラが仮想ネットワークのインストールについて、またPythonとの連携について確認を取ってきますが、そのまま進めても問題ありません。

インストール終了後、Finishボタンをクリックするとインストーラが終了し、VirtualBoxが起動します。

## VirtualBoxの起動
VirtualBoxを起動します。

インストーラが自動で起動した状態ではない場合には、デスクトップ上に追加されたVirtualBoxをダブルクリックして起動します。

VirtualBoxが起動すると、VirtualBoxマネージャーが表示されます。

![VirtualBoxマネージャーの画面](image/Ch2/VirtualBoxManager.png){width=70%}

### VirtualBoxマネージャー
VirtualBoxマネージャーは、VirtualBoxによる仮想マシン実行環境全体を管理するツールです。主に以下のことが行えます。

- VirtualBox自身の各種設定
- 仮想マシンの管理
- メディア（ISOイメージ等）の管理
- 仮想ネットワークの管理

## ホストキーによるホストOSの操作への復帰
仮想マシンをマウスで操作している際に、ホストOSにマウス操作を戻したくなった場合にはホストキーを押します。デフォルトではキーボード右側のCtrlキーがホストキーに設定されています。ホストキーの設定は、仮想マシンのウインドウの右下にも表示されています。

### ホストキーが押せない場合のホストOSの操作への復帰
キーボードによっては右Ctrlキーが無いため、仮想マシンの操作から抜け出せなくなります。そのような場合になった場合には、OSをシャットダウンして仮想マシンを停止すれば操作をホストOS側に戻すことができます。

### ホストキーの変更
VirtualBoxマネージャーの環境設定から、ホストキーを変更できます。

環境設定は、VirtualBoxマネージャーの「ファイル(F)」メニューから「環境設定(P)」を選択して呼び出します。「環境設定」ウインドウが表示されたら、左側の設定項目から「入力」を選択し、「仮想マシン(M)」タブを選択します。一番最初にある「ホストキーの組み合わせ」の「ショートカット」部分をクリックします。新たにホストキーにしたいキーを押すことで、ホストキーがそのキーに切り替わります。

![ホストキーの設定画面](image/Ch2/configHostKey.png){width=70%}

ホストキーに設定できるのはCtrlキー、Altキー、Windowsキー、Shiftキー（単独設定不可）です。左のCtrlキーをホストキーに設定してしまうと、コマンドライン操作などの際に重複してしまうので、避けた方がよいでしょう。複数のキーを同時に押す組み合わせをホストキーにすることもできるので、2つないし3つのキーの組み合わせをホストキーとして設定するとよいでしょう。

\pagebreak
## 仮想マシンの作成
仮想マシンを作成します。

VirtualBoxマネージャーで「新規(N)」ボタンをクリックし、新しい仮想マシンの作成を開始します。各種設定を対話形式で設定していくガイド付きモードと、1つの画面で設定できるエキスパートモードが選択できます。

ここではデフォルトのガイド付きモードで作成します。

### 仮想マシンの名前とOSの設定
まず最初に、仮想マシンの名前とOSの種類などを設定します。これらの設定は後から変更することもできるので、その他の項目で必要なものは後ほど設定を行います。

設定する項目と、設定する内容は以下の通りです。

| 項目 | 設定値 |
|------------|---------------|
| 名前 | host1.example1.jp |
| タイプ | Linux |
| バージョン | Red Hat 9.x (64-bit) |

設定したら、「次へ」ボタンをクリックします。

![仮想マシンの名前とOS選択の画面](image/Ch2/NewVMnameOS.png){width=70%}

\pagebreak
### 仮想マシンのハードウェアの設定
仮想マシンのハードウェアの設定として、メインメモリーの容量とプロセッサの数を設定します。また、EFIの設定も行います。

| 項目 | 設定値 |
|------------|---------------|
| メインメモリー | 2048MB |
| Processors | 1 |
| Enable EFI(special OSes only) | チェックする |

![仮想マシンのメモリやCPU設定の画面](image/Ch2/NewVMmemoryCPU.png){width=70%}

メインメモリーの容量は、使用しているコンピュータが搭載しているメモリ容量以下に制限されます。仮想マシンにある程度多めのメインメモリーを割り当てることで快適に動作させることができます。デフォルトの2048MBでも動作しますが、余裕があれば4096MB（4GB）割り当ててもよいでしょう。

プロセッサの数は、使用しているコンピュータが搭載しているプロセッサのコア数以下に制限されます。また、プロセッサによっては仮想CPU機能により見かけ上コア数が2倍になっている場合もあります。デフォルトの1つでも動作しますが、余裕があれば2つ割り当ててもよいでしょう。

Enable EFIは、デフォルトではチェックされていません。OSのインストール画面のサイズが合わず一部の画面が見えなくなる問題が発生するため、チェックしておきます。

設定しましたら、「次へ」ボタンをクリックします。

\pagebreak
### 仮想ハードディスクの設定
OSのインストール先となる仮想ハードディスクの設定をします。

| 項目 | 設定値 |
|------------|---------------|
| Disk Size | 20.00GB |

![仮想ハードディスクの設定画面](image/Ch2/NewVMharddisk.png){width=70%}

仮想ハードディスクの容量は、使用しているコンピュータが搭載しているストレージの容量以下に制限されます。また、「Pre-allocate Full Size」をチェックしない限り、仮想ハードディスクの容量はゲストOSが使用した分だけしか消費しませんので、設定は最大消費容量を指定することになります。

OSのインストールとサーバーの設定だけではそれほど沢山の容量を必要としませんが、実際に運用するサーバーを作る場合には必要な容量を見積もって設定する必要があります。また、後から仮想ハードディスクを追加することもできるので、追加方法について学習してもよいでしょう。

設定しましたら、「次へ」ボタンをクリックします。

\pagebreak
### 仮想マシンの設定を確認
最後に仮想マシンの設定を確認します。ここまでの手順で設定した内容が反映されているかどうか、あらためて確認します。

確認後、「完了」ボタンをクリックします。

![仮想マシンの設定確認画面](image/Ch2/NewVMspec.png){width=70%}

VirtualBoxマネージャーに、新しく作成した仮想マシンが追加されたことを確認します。

\pagebreak
## 仮想マシンの設定方法
仮想マシンの設定を確認したり、変更するには、VirtualBoxマネージャーで仮想マシンを選択し、右側に表示される各種設定情報から変更が行えます。設定項目の見出し部分（「一般」や「システム」など）をクリックすると、その項目の設定画面が表示されます。

![仮想マシンの設定画面](image/Ch2/NewVMconfig.png){width=70%}

試しに、仮想マシン作成時に設定したEFIの有効化について確認してみます。

### EFIの有効化を確認
仮想マシン作成時にEFIの有効化を行っていないと、OSのインストーラを起動した際に画面のサイズが合わず一部の画面が見えなくなる問題が発生します。

「システム」をクリックし、以下の設定にチェックが入っていることを確認します。チェックが入っていない場合にはチェックします。

確認、あるいは修正ができたら、「OK」ボタンをクリックします。

![仮想マシンのシステム設定の画面](image/Ch2/NewVMEFI.png){width=70%}

\pagebreak
## ネットワークの追加 
ホストマシンと仮想マシンが通信できるようにするため、以下の手順で「ホストオンリーアダプター」を追加します。

デフォルトではNATを使った外部ネットワークに接続するネットワークのみ設定されています。

![NAT](image/Ch2/NAT.png){width=70%}

\pagebreak
### 仮想ネットワークの設定を確認
VirtualBoxの仮想ネットワークの設定を確認します。

VirtualBoxマネージャーの「ツール」右側のリストボタン（横3本線）をクリックし、「ネットワーク」を選択します。

「Host-only Networks」タブを選択し、「VirtualBox Host-Only Ethernet Adapter」が存在していることを確認します。IPアドレスは、インストール時に自動的に作成された場合には192.168.56.1/24が設定されています。このIPアドレスは、ホストOSに作成された仮想ネットワークアダプターに割り当てられているIPアドレスです。

DHCPサーバーもデフォルトで有効になっていますが、本教科書の演習ではDHCPサーバーは使用しません。

![仮想ネットワークの設定画面](image/Ch2/configHostOnly.png){width=70%}

![ホストオンリーアダプター](image/Ch2/HostOnly.png){width=70%}

\pagebreak
\pagebreak
### 仮想マシンにネットワークアダプターを追加
仮想マシンにネットワークアダプターを追加します。

VirtualBoxマネージャーから仮想マシンを選択し、右側の各種設定情報から「ネットワーク」を選択します。

仮想マシンには最大4つのネットワークアダプターを設定できます。アダプター1はNATが設定されており、外部のネットワークやその先にあるインターネットに接続できます。

![仮想マシンのネットワークアダプター1の設定画面](image/Ch2/VMconfigNAT.png){width=70%}

アダプター2のタブを選択し、「ネットワークアダプターを有効化」をチェックします。「割り当て」を「ホストオンリーアダプター」に設定すると、「名前」に「VirtualBox Host-Only Ethernet Adapter」が設定されます。これによって、この仮想マシンはホストマシンと通信が行えるようになります。

設定したら、「OK」をクリックします。

![仮想マシンのネットワークアダプター2の設定画面](image/Ch2/VMconfigHostOnly.png){width=70%}

\pagebreak
## ISOイメージを仮想光学ドライブで読み込む設定
第1章でダウンロードしたOSインストール用のISOイメージを、仮想マシンの仮想光学ドライブで読み込む設定をします。

VirtualBoxマネージャーから仮想マシンを選択し、右側の各種設定情報から「ストレージ」を選択します。

仮想マシンには、IDEとSATAの2種類のストレージデバイスが接続されています。仮想光学ドライブはIDEに接続されています。読み込む設定が何もされていない場合、「空」と表示されているのが仮想光学ドライブですので、選択します。

「光学ドライブ:IDE セカンダリマスター」の右側にある円形のボタンをクリックし、「ディスクファイルを選択」を選択すると、ファイルダイアログが開きます。準備しておいたOSインストール用のISOイメージを選択し、「開く」ボタンをクリックします。「空」の表示がファイル名に変わります。

![仮想マシンの仮想光学ドライブの設定画面](image/Ch2/VMconfigDVD.png){width=70%}

以上で仮想マシンの作成と、OSインストールの準備は完了です。

\pagebreak
