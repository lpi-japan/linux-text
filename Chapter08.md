# ユーザーとグループの管理
ユーザーとグループは、Linuxのシステムを制御するための基本的な単位として機能します。

本章では、ユーザーとグループの管理について解説します。ユーザーの作成や削除、ユーザーパスワードの設定、グループを作成してユーザーを割り当てたりグループ設定の変更やグループの削除について理解を深めましょう。

本章の内容
- ユーザーとグループ
- システムを管理するユーザーroot
- ユーザーの管理
- グループの管理
- パスワードファイル/etc/passwdとシャドウファイル/etc/shadow

## ユーザーとグループ
ユーザーは、Linuxを利用するための基本的な単位です。たとえばLinuxを操作するには、ユーザーでログインします。メールサーバーであれば、各ユーザー宛のメールを受け取ることができます。

グループは、複数のユーザーをまとめて管理する仕組みです。ある特定のグループに所属しているユーザーだけがシステムを管理できる、というような使い方をします。ファイルサーバーであれば、特定のグループだけで読み書きできるファイル共有を作成できます。

ユーザーとグループを適切に設定することで、ファイルやディレクトリ、任意のプログラムやシェルスクリプトなどを必要なユーザーにのみ参照・編集する権限や実行する権限を与えることができます。

## システムを管理するユーザーroot
Linuxのシステム全体を管理するユーザーはrootです。rootはすべてのファイルに対するアクセスが許可されていたり、システム管理用のコマンドが実行できるなど、一般ユーザーに比べて強力な権限を持っているので、「特権ユーザー」や「スーパーユーザー」などと呼ばれます。

rootとして操作が行えると、システムを乗っ取ったり破壊したりできるので、セキュリティの観点からrootは厳格に管理する必要があります。

rootで作業をするには、suコマンドでユーザーを切り替えるか、sudoコマンドでrootの権限でコマンドを実行します。実務でシステム管理を行う際には、sudoコマンドを使う方法が一般的です。

### suコマンド
su（SUbstitute）コマンドはすでに別のユーザーでログインしているユーザーが、一時的に他のユーザーに切り替えるためのコマンドです。

suコマンドの引数として、切り替え先のユーザーを指定します。省略するとrootを指定したことになります。

切り替え先ユーザーのパスワードを入力する必要があります。パスワードが設定されていないユーザーには切り替えられません。

オプションを省略すると、シェルなどの環境をそのまま引き継いでユーザーだけが切り替わります。「-」オプションを指定して実行すると、指定したユーザーでログインし直したのと同じ環境が設定されてユーザーが切り替わります。

```
書式
su [-] [ユーザー]

オプション
-
ログインシェルを起動してユーザーを切り替える
```

### suコマンドでrootに切り替える
suコマンドを実行して、一般ユーザーからrootに切り替えます。切り替える際には、rootのパスワードを入力する必要があります。インストール時にrootのパスワードを設定していない場合、suコマンドでrootに切り替えることはできません。現在ではセキュリティ保護の観点から、rootのパスワードを設定せず、suコマンドを実行できないように設定することが多くなっています。

idコマンドを実行すると、ユーザーIDや所属しているグループが確認できます。

```
書式
id [ユーザー]
```

以下の実習を行いたい場合には、次のsudoコマンドの使い方を先に学習して、sudoコマンドを使ってrootのパスワードを設定した後、実習を行ってください。手順については後述します。

```
$ su -
パスワード: ※rootのパスワードを入力（非表示）
最終ログイン: 2024/08/11 (日) 17:19:01 JST 日時 pts/1
# id
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
# exit
ログアウト
```

### sudoコマンドを使ってroot権限でコマンドを実行する
sudoコマンドを実行すると、引数として与えられたコマンドをroot権限で実行できます。

普段の作業は一般ユーザーで行ない、必要に応じてsudoコマンドを使ってシステム管理用のコマンドを実行することで、suコマンドなどでユーザーをrootに切り替えることなく、root権限が必要なシステム管理を行えます。

sudoを実行するには、実行する権限が与えられていることと、実行したユーザーのパスワードが必要です。パスワードは1回入力すると、デフォルトで5分間は省略できます。パスワード入力は設定変更で省略させることもできます。権限付与と設定変更は後述します。

```
書式
sudo コマンド
```

一般ユーザーではアクセスできないファイルも、sudoコマンドを使うとroot権限でコマンドを実行しアクセス権限を得ることができます。

```
$ id linuc
uid=1000(linuc) gid=1000(linuc) groups=1000(linuc),10(wheel)
$ tail /var/log/messages
tail: '/var/log/messages' を 読み込み用に開くことが出来ません: 許可がありません
$ sudo tail /var/log/messages

あなたはシステム管理者から通常の講習を受けたはずです。
これは通常、以下の3点に要約されます:

    #1) 他人のプライバシーを尊重すること。
    #2) タイプする前に考えること。
    #3) 大いなる力には大いなる責任が伴うこと。

[sudo] linuc のパスワード: ※ユーザーlinucのパスワードを入力（非表示）
Aug 15 12:00:13 localhost systemd[15213]: Created slice User Background Tasks Slice.
Aug 15 12:00:13 localhost systemd[15213]: Starting Cleanup of User's Temporary Files and Directories...
（略）
```

/var/log/messagesは一般ユーザーではアクセスできないログファイルでしたが、sudoコマンドでtailコマンドをroot権限で実行したことでアクセスすることができました。

以下の説明でsudoコマンドをつけて実行しているコマンドは、すべてroot権限が必要なシステム管理用のコマンドの実行、あるいはroot権限が必要なファイルに対するアクセスを行っています。

### wheelグループ所属を確認する
sudoコマンドは、デフォルトの設定ではwheelグループに所属しているユーザーに実行を許可しています。

idコマンドを実行して、自分の所属しているグループを確認します。

```
$ id
uid=1000(linuc) gid=1000(linuc) groups=1000(linuc),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```

wheelグループに所属していることがわかります。インストール時に「このユーザーを管理者にする」をチェックして作成したユーザーは、sudoコマンドを実行できるようwheelグループに最初から所属しています。

### sudoコマンドをパスワード無しで実行できるようにする
sudoコマンドの設定を変更して、パスワード無しでsudoコマンドを実行できるようにします。

sudoコマンドの設定は/etc/sudoersに記述されています。この設定ファイルはviで直接修正するのではなく、visudoコマンドを実行して修正します。

```
$ sudo visudo
[sudo] linuc のパスワード: ※ユーザーlinucのパスワードを入力（非表示）
```

viで/etc/sudoersが開けたら、以下の設定行を見つけて変更し、保存、終了します（viの編集モードでコマンド:wq）。設定は即時有効になります。

```
## Allows people in group wheel to run all commands
%wheel  ALL=(ALL)       ALL
```
↓ 行頭に「# 」を入れてコメントアウトする
```
# %wheel  ALL=(ALL)       ALL
```

```
## Same thing without a password
# %wheel        ALL=(ALL)       NOPASSWD: ALL
```
↓ 行頭のコメントアウト「# 」を削除して有効にする
```
%wheel        ALL=(ALL)       NOPASSWD: ALL
```

最初の設定は、wheelグループに所属している（%wheel）ユーザーはsudoコマンドを実行できる、パスワードは必要、という設定です。この設定をコメントアウトして無効にしました。コメントアウトするには行頭に「# 」と記述します。

次の設定は、wheelグループに所属しているすべてのユーザーはsudoコマンドを実行できる、パスワードは不要（NOPASSWD: ALL）、という設定です。この設定の行頭のコメントアウトを外して有効にしました。

前のsudoコマンド実行から5分以上時間をあけて、再度sudoコマンドを実行してみてください。パスワード入力無しで実行できるようになっています。

## ユーザーの管理
システム管理者は必要に応じて、ユーザーの作成や削除を行います。

たとえば、ログインして何か作業をさせたい場合のほか、メールサーバーであればメールアカウントを発行するためにユーザーを作成します。

### ユーザーの作成
新しくユーザーを作成するにはuseraddコマンドを使います。ユーザー作成にはroot権限が必要となります。

ユーザーは必ずグループに所属します。これをプライマリグループ（主グループ）と呼びます。ユーザーはさらに複数のサブグループに所属することもできます。

作成したユーザーの情報は/etc/passwdに記述されます。詳細は後述します。

useraddコマンドでユーザーを作成すると、自動的に/homeディレクトリの下にユーザー名でホームディレクトリを作成さて、必要なファイルをコピーしてくれます。

作成したユーザーでログインするためにパスワード認証を行う場合には、後述するpasswdコマンドを使ってパスワードを登録する必要があります。

```
書式
useradd ユーザー名

オプション
-g グループ名
プライマリグループ名を指定します。グループ名は/etc/groupで定義したグループ名です。

-G グループ名
サブグループを指定します。複数のグループを指定する場合には「,」（カンマ）で区切ります。
```

以下の実行例では、ユーザーsatoを作成します。

```
$ sudo useradd sato
$ grep sato /etc/passwd
sato:x:1001:1001::/home/sato:/bin/bash
$ ls -ld /home/sato
drwx------. 3 sato sato 78  8月 15 14:03 /home/sato
```

ユーザーsatoは、satoグループに所属し、ホームディレクトリとして/home/satoが作成されて割り当てられているのがわかります。

### パスワードの設定
ユーザーのパスワードを設定するには、passwdコマンドを使います。

一般ユーザーは自分のパスワードのみ設定できます。rootはすべてのユーザーのパスワードを設定できます。

```
書式
passwd [ユーザー]
```

以下の実行例では、ユーザーsatoのパスワードを変更します。

```
$ sudo passwd sato
ユーザー sato のパスワードを変更。
新しい パスワード: ※新しいパスワードを入力（非表示）
新しい パスワードを再入力してください: ※新しいパスワードを入力（非表示）
passwd: すべての認証トークンが正しく更新できました。
```

root権限でpasswdコマンドを実行すると強制的にパスワードを設定できるので、現在のパスワードを入力する必要がありません。一般ユーザーが自分のパスワードを変更するときには現在のパスワードの入力が要求されます。

### rootのパスワードを設定してsuコマンドを実行する
suコマンドの説明で、OSインストール時にrootのパスワードを設定していないため、suコマンドでrootに切り替えることができませんでした。

以下の手順でrootのパスワードを設定することで、suコマンドでrootに切り替えられるようになります。

```
$ sudo passwd root
ユーザー root のパスワードを変更。
新しい パスワード: ※rootの新しいパスワードを入力（非表示）
新しい パスワードを再入力してください: ※rootの新しいパスワードを再入力（非表示）
passwd: すべての認証トークンが正しく更新できました。
$ su -
パスワード: ※rootのパスワードを入力（非表示）
# id
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```

suコマンドでrootに切り替えられました。

### ユーザーアカウントの変更
ユーザーのアカウント情報を変更するにはusermodコマンドを使います。

```
書式
usermod  ユーザー名

-g グループ
プライマリグループを変更します。グループ名は/etc/groupで定義したグループ名です。

-G グループ
サブグループを変更します。複数のグループを指定する場合には「,」（カンマ）で区切ります。

-a
サブグループの変更（-G）を追加として処理します。
```

以下の実行例では、ユーザーsatoのサブグループとしてwheelグループを指定します。

```
$ id sato
uid=1001(sato) gid=1001(sato) groups=1001(sato)
$ sudo usermod -G wheel sato
uid=1001(sato) gid=1001(sato) groups=1001(sato),10(wheel)
```

ユーザーsatoのサブグループにwheelグループが追加されました。

サブグループを指定する-Gオプションは、所属させたいサブグループをすべてカンマ区切りで指定する必要があるため、指定忘れがあるとそのサブグループの所属から外れてしまいます。-aオプションを併用すると、既に所属しているサブグループはそのままに指定したサブグループを追加できます。

```
$ sudo usermod -G kvm -a sato
$ id sato
uid=1001(sato) gid=1001(sato) groups=1001(sato),10(wheel),36(kvm)
```

kvmグループがサブグループとして追加されました。

### ユーザーの削除
ユーザーを削除するにはuserdelコマンドを使います。

```
書式
userdel ユーザー名

オプション
-r
ホームディレクトリを削除します。
```

以下の実行例では、ユーザーtestを作成し、削除します。

```
$ sudo useradd test
$ id test
uid=1002(test) gid=1002(test) groups=1002(test)
$ ls -ld /home/test
drwx------. 3 test test 78  8月 15 14:29 /home/test
$ sudo userdel -r test
$ id test
id: `test': no such user
$ ls -ld /home/test
ls: '/home/test' にアクセスできません: そのようなファイルやディレクトリはありません
```

-rオプションを付けて実行することで、ホームディレクトリも削除されているのがわかります。

## グループの管理
複数のユーザーをまとめて扱うためにグループを使います。

最初から用意されているグループに加え、システム管理者が必要に応じてグループを作成できます。

グループの定義は/etc/groupに記述されます。詳細は後述します。

### グループの作成
新しくグループを作成するにはgroupaddコマンドを使います。

```
書式
groupadd グループ
```

以下の実行例では、testグループを追加し、ユーザーsatoのサブグループに設定します。

```
$ sudo groupadd test
$ sudo usermod -G test -a sato
$ grep test /etc/group
test:x:1002:sato
```

ユーザーのサブグループは/etc/groupに所属しているユーザーとして記述されます。上記の例では、testグループにユーザーsatoが所属しているのがわかります。

### グループを削除
グループを削除するにはgroupdelコマンドを使います。

ユーザーのプライマリグループは削除できませんが、サブグループは削除できてしまうので注意してください。

```
書式
groupdel グループ名
```

以下の実行例では、testグループを削除しています。またlinucグループを削除しようとしています。

```
$ sudo groupdel test
$ grep test /etc/group
※グループが削除されたので何も表示されない
$ sudo groupdel linuc
groupdel: ユーザー 'linuc' のプライマリグループは削除できません。
```

testグループにはユーザーsatoが所属していましたが、サブグループだったので削除できました。linucグループはユーザーlinucのプライマリーグループなので削除できません。

## パスワードファイル/etc/passwdとシャドウファイル/etc/shadow
ユーザーの定義は/etc/passwd(パスワードファイル)に記述されています。

ユーザーに設定したパスワードは、古いUNIXでは/etc/passwdに記述されていましたが、現在ではセキュリティのためパスワードは/etc/shadowファイル(シャドウファイル)に記述されています。

### パスワードファイル(/etc/passwd)
ユーザーの情報は/etc/passwdファイル(パスワードファイル)に保存され、1行に1ユーザーの情報を:で区切って記述します。

パスワードファイルに登録された1ユーザーの内容(1行)は次の様になります。

```
ユーザー名: パスワード:UID:GID:コメント:ホームディレクトリ:ログインシェル
```

パスワードファイルの内容
| 項目| 内容
|-|-
| ユーザー名 | そのシステムでのユーザー名。大文字を含まないようにする
| パスワード | 以前はユーザーの暗号化されたパスワード、現在はxです
| UID | ユーザーID番号
| GID | ユーザーが属するプライマリグループ ID 番号
| コメント | ユーザーの名前またはコメントのフィールド
| ホームディレクトリ | ユーザーのホームディレクトリ
| ログインシェル | ログイン時に起動されるユーザーのコマンドインタプリタ

パスワードファイルはエディタで直接編集するべきではありません。useraddコマンドなどのコマンドを使って操作することが推奨されます。

### シャドウファイル(/etc/shadow)
ユーザーのパスワードはパスワードファイルではなく、シャドウファイル(/etc/shadow)に保存されます。

シャドウファイルに登録された1つのユーザー(1行)の内容は次の様になります。

```
ユーザー名:パスワード:最終変更日:変更可能日:変更要求日:警告日数:無効日数:失効日数:予約
```

シャドウファイルの内容
| 項目 | 内容	
|-|-
| ユーザー名 | ユーザー名
| パスワード | パスワード
| 最終変更日 | 1970 年 1 月 1 日から、最後にパスワードが変更された日までの日数
| 変更可能日数 | パスワードが変更可能となるまでの日数
| 変更要求日数 | パスワードを変更しなくてはならなくなる日までの日数
| 警告日数 | パスワード有効期限が来る前に、ユーザーが警告を受ける日数
| 無効日数 | パスワード有効期限が過ぎ、アカウントが使用不能になるまでの日数
| 失効日数 | 1970 年 1 月 1 日からアカウントが使用不能になる日までの日数
| 予約 | 予約フィールド

シャドウファイルはエディタで直接編集するべきではありません。日付に使われている1970年1月1日はLinuxがシステムの基準としている年月日です。

### グループファイル(/etc/group)
グループの情報は/etc/groupファイル(グループファイル)に保存され、1行に1グループの情報を:で区切って記述します。

グループファイルに登録された1つのグループの内容(1行)は次の様になります。

```
グループ名: パスワード:GID: ユーザー
```

グループファイルの内容
| 項目 | 内容	
|-|-
| グループ名 | グループの名前。
| パスワード | 以前は暗号化されたグループのパスワード、またはパスワードが不要なら空欄
| GID | グループID番号
| ユーザー | グループに所属するユーザー名のリスト。それぞれのユーザー名はコンマで区切られる。

グループファイルはエディタで直接編集するべきではありません。groupaddコマンドなどのコマンドを使って操作することが推奨されます。

\pagebreak

